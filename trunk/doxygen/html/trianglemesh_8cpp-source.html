<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>pbrt: trianglemesh.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>trianglemesh.cpp</h1><a href="trianglemesh_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 <span class="comment">/*</span>
<a name="l00003"></a>00003 <span class="comment">    pbrt source code Copyright(c) 1998-2007 Matt Pharr and Greg Humphreys.</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">    This file is part of pbrt.</span>
<a name="l00006"></a>00006 <span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment">    pbrt is free software; you can redistribute it and/or modify</span>
<a name="l00008"></a>00008 <span class="comment">    it under the terms of the GNU General Public License as published by</span>
<a name="l00009"></a>00009 <span class="comment">    the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00010"></a>00010 <span class="comment">    (at your option) any later version.  Note that the text contents of</span>
<a name="l00011"></a>00011 <span class="comment">    the book "Physically Based Rendering" are *not* licensed under the</span>
<a name="l00012"></a>00012 <span class="comment">    GNU GPL.</span>
<a name="l00013"></a>00013 <span class="comment"></span>
<a name="l00014"></a>00014 <span class="comment">    pbrt is distributed in the hope that it will be useful,</span>
<a name="l00015"></a>00015 <span class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00016"></a>00016 <span class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00017"></a>00017 <span class="comment">    GNU General Public License for more details.</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">    You should have received a copy of the GNU General Public License</span>
<a name="l00020"></a>00020 <span class="comment">    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00021"></a>00021 <span class="comment"></span>
<a name="l00022"></a>00022 <span class="comment"> */</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="comment">// trianglemesh.cpp*</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include "<a class="code" href="shape_8h.html">shape.h</a>"</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="paramset_8h.html">paramset.h</a>"</span>
<a name="l00027"></a>00027 <span class="comment">// TriangleMesh Declarations</span>
<a name="l00028"></a><a class="code" href="classTriangleMesh.html">00028</a> <span class="keyword">class </span><a class="code" href="classTriangleMesh.html">TriangleMesh</a> : <span class="keyword">public</span> <a class="code" href="classShape.html">Shape</a> {
<a name="l00029"></a>00029 <span class="keyword">public</span>:
<a name="l00030"></a>00030         <span class="comment">// TriangleMesh Public Methods</span>
<a name="l00031"></a>00031         <a class="code" href="classTriangleMesh.html#6db6aa1e1ecc4de8ea00135faf3c0894">TriangleMesh</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;o2w, <span class="keywordtype">bool</span> ro,
<a name="l00032"></a>00032                      <span class="keywordtype">int</span> <a class="code" href="classTriangleMesh.html#34fc75652396b91479ffe2cc0596bea4">ntris</a>, <span class="keywordtype">int</span> <a class="code" href="classTriangleMesh.html#965bd9d2dfd9e10768dc19c53f77726d">nverts</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> *vptr,
<a name="l00033"></a>00033                                  <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> *P, <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> *<a class="code" href="util_8cpp.html#0240ac851181b84ac374872dc5434ee4">N</a>,
<a name="l00034"></a>00034                                  <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> *S, <span class="keyword">const</span> <span class="keywordtype">float</span> *uv);
<a name="l00035"></a>00035         <a class="code" href="classTriangleMesh.html#d2e6daebfd73b0f3cf832b13a2bf300d">~TriangleMesh</a>();
<a name="l00036"></a>00036         <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classTriangleMesh.html#79f842f87641104c22d08a3e3ec4ca96">ObjectBound</a>() <span class="keyword">const</span>;
<a name="l00037"></a>00037         <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classTriangleMesh.html#6d9bcc0ccb5c431c2ce0a07ad00c9781">WorldBound</a>() <span class="keyword">const</span>;
<a name="l00038"></a><a class="code" href="classTriangleMesh.html#81dbc8e3220902a36dae2ca44f854a84">00038</a>         <span class="keywordtype">bool</span> <a class="code" href="classTriangleMesh.html#81dbc8e3220902a36dae2ca44f854a84">CanIntersect</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <span class="keyword">false</span>; }
<a name="l00039"></a>00039         <span class="keywordtype">void</span> <a class="code" href="classTriangleMesh.html#60c339321ae481e2be159ffe53150bd9">Refine</a>(vector&lt;<a class="code" href="classReference.html">Reference&lt;Shape&gt;</a> &gt; &amp;refined) <span class="keyword">const</span>;
<a name="l00040"></a><a class="code" href="classTriangleMesh.html#ba092fd6e60b7ff6fa22bde077b16e48">00040</a>         <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classTriangle.html">Triangle</a>;
<a name="l00041"></a><a class="code" href="classTriangleMesh.html#ccf22c7072c4f191436213abbe9405d8">00041</a>         <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt; <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classTriangleMesh.html#ccf22c7072c4f191436213abbe9405d8">VertexTexture</a>;
<a name="l00042"></a>00042 <span class="keyword">protected</span>:
<a name="l00043"></a>00043         <span class="comment">// TriangleMesh Data</span>
<a name="l00044"></a><a class="code" href="classTriangleMesh.html#965bd9d2dfd9e10768dc19c53f77726d">00044</a>         <span class="keywordtype">int</span> ntris, nverts;
<a name="l00045"></a><a class="code" href="classTriangleMesh.html#4bd96a5a81338f923be058ea90cd4dfe">00045</a>         <span class="keywordtype">int</span> *<a class="code" href="classTriangleMesh.html#4bd96a5a81338f923be058ea90cd4dfe">vertexIndex</a>;
<a name="l00046"></a><a class="code" href="classTriangleMesh.html#c29b8860d6b8b1c55adc600be837f016">00046</a>         <a class="code" href="classPoint.html">Point</a> *<a class="code" href="classTriangleMesh.html#c29b8860d6b8b1c55adc600be837f016">p</a>;
<a name="l00047"></a><a class="code" href="classTriangleMesh.html#488610e36c82f45af88a585f961d8885">00047</a>         <a class="code" href="classNormal.html">Normal</a> *<a class="code" href="classTriangleMesh.html#488610e36c82f45af88a585f961d8885">n</a>;
<a name="l00048"></a><a class="code" href="classTriangleMesh.html#bdbdc2862be701d2880802aa43719fab">00048</a>         <a class="code" href="classVector.html">Vector</a> *<a class="code" href="classTriangleMesh.html#bdbdc2862be701d2880802aa43719fab">s</a>;
<a name="l00049"></a><a class="code" href="classTriangleMesh.html#499d9df5fe9b544ff03f8f79e7a83113">00049</a>         <span class="keywordtype">float</span> *<a class="code" href="classTriangleMesh.html#499d9df5fe9b544ff03f8f79e7a83113">uvs</a>;
<a name="l00050"></a>00050 };
<a name="l00051"></a><a class="code" href="classTriangle.html">00051</a> <span class="keyword">class </span><a class="code" href="classTriangle.html">Triangle</a> : <span class="keyword">public</span> <a class="code" href="classShape.html">Shape</a> {
<a name="l00052"></a>00052 <span class="keyword">public</span>:
<a name="l00053"></a>00053         <span class="comment">// Triangle Public Methods</span>
<a name="l00054"></a><a class="code" href="classTriangle.html#0df8e3885f7bb230a8adcd51a29e9e26">00054</a>         <a class="code" href="classTriangle.html#0df8e3885f7bb230a8adcd51a29e9e26">Triangle</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;o2w, <span class="keywordtype">bool</span> ro,
<a name="l00055"></a>00055                  <a class="code" href="classTriangleMesh.html">TriangleMesh</a> *m, <span class="keywordtype">int</span> n)
<a name="l00056"></a>00056                         : <a class="code" href="classShape.html">Shape</a>(o2w, ro) {
<a name="l00057"></a>00057                 <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a> = m;
<a name="l00058"></a>00058                 <a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a> = &amp;<a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;vertexIndex[3*n];
<a name="l00059"></a>00059                 <span class="comment">// Update created triangles stats</span>
<a name="l00060"></a>00060                 <span class="keyword">static</span> <a class="code" href="classStatsCounter.html">StatsCounter</a> trisMade(<span class="stringliteral">"Geometry"</span>,
<a name="l00061"></a>00061                                              <span class="stringliteral">"Triangles created"</span>);
<a name="l00062"></a>00062                 ++trisMade;
<a name="l00063"></a>00063         }
<a name="l00064"></a>00064         <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classTriangle.html#5b81f9acac2c513b82e0df8a98a3ce3d">ObjectBound</a>() <span class="keyword">const</span>;
<a name="l00065"></a>00065         <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classTriangle.html#71c6c6faae282bb1166458360a9b3382">WorldBound</a>() <span class="keyword">const</span>;
<a name="l00066"></a>00066         <span class="keywordtype">bool</span> <a class="code" href="classTriangle.html#b801413505392b1bb09fc1e0069f7754">Intersect</a>(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray, <span class="keywordtype">float</span> *tHit,
<a name="l00067"></a>00067                        <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a> *dg) <span class="keyword">const</span>;
<a name="l00068"></a>00068         <span class="keywordtype">bool</span> <a class="code" href="classTriangle.html#ff98443b083b9c464d687324c7b41e9d">IntersectP</a>(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray) <span class="keyword">const</span>;
<a name="l00069"></a>00069         <span class="keywordtype">void</span> <a class="code" href="classTriangle.html#16a1dfa4d0a70aaff42e0bddb99931ca">GetUVs</a>(<span class="keywordtype">float</span> uv[3][2]) <span class="keyword">const</span>;
<a name="l00070"></a>00070         <span class="keywordtype">float</span> <a class="code" href="classTriangle.html#d3885c40e78c33327a622351dbb07ed7">Area</a>() <span class="keyword">const</span>;
<a name="l00071"></a><a class="code" href="classTriangle.html#906c765c66601775a6c3adf527abc4e7">00071</a>         <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classTriangle.html#906c765c66601775a6c3adf527abc4e7">GetShadingGeometry</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;obj2world,
<a name="l00072"></a>00072                         <span class="keyword">const</span> <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a> &amp;dg,
<a name="l00073"></a>00073                         <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a> *dgShading)<span class="keyword"> const </span>{
<a name="l00074"></a>00074                 <span class="keywordflow">if</span> (!<a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;n &amp;&amp; !<a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;s) {
<a name="l00075"></a>00075                         *dgShading = dg;
<a name="l00076"></a>00076                         <span class="keywordflow">return</span>;
<a name="l00077"></a>00077                 }
<a name="l00078"></a>00078                 <span class="comment">// Initialize _Triangle_ shading geometry with _n_ and _s_</span>
<a name="l00079"></a>00079                 <span class="comment">// Compute barycentric coordinates for point</span>
<a name="l00080"></a>00080                 <span class="keywordtype">float</span> b[3];
<a name="l00081"></a>00081                 <span class="comment">// Initialize _A_ and _C_ matrices for barycentrics</span>
<a name="l00082"></a>00082                 <span class="keywordtype">float</span> uv[3][2];
<a name="l00083"></a>00083                 <a class="code" href="classTriangle.html#16a1dfa4d0a70aaff42e0bddb99931ca">GetUVs</a>(uv);
<a name="l00084"></a>00084                 <span class="keywordtype">float</span> A[2][2] =
<a name="l00085"></a>00085                     { { uv[1][0] - uv[0][0], uv[2][0] - uv[0][0] },
<a name="l00086"></a>00086                       { uv[1][1] - uv[0][1], uv[2][1] - uv[0][1] } };
<a name="l00087"></a>00087                 <span class="keywordtype">float</span> C[2] = { dg.<a class="code" href="structDifferentialGeometry.html#25fb75c2f13a530489cd1776171d3736">u</a> - uv[0][0], dg.<a class="code" href="structDifferentialGeometry.html#ad45a8e22d41f9c7116211c3f2372550">v</a> - uv[0][1] };
<a name="l00088"></a>00088                 <span class="keywordflow">if</span> (!<a class="code" href="pbrt_8h.html#bc9110183d0d45769bb48ac20928a7a5">SolveLinearSystem2x2</a>(A, C, &amp;b[1])) {
<a name="l00089"></a>00089                         <span class="comment">// Handle degenerate parametric mapping</span>
<a name="l00090"></a>00090                         b[0] = b[1] = b[2] = 1.f/3.f;
<a name="l00091"></a>00091                 }
<a name="l00092"></a>00092                 <span class="keywordflow">else</span>
<a name="l00093"></a>00093                         b[0] = 1.f - b[1] - b[2];
<a name="l00094"></a>00094                 <span class="comment">// Use _n_ and _s_ to compute shading tangents for triangle, _ss_ and _ts_</span>
<a name="l00095"></a>00095                 <a class="code" href="classNormal.html">Normal</a> ns;
<a name="l00096"></a>00096                 <a class="code" href="classVector.html">Vector</a> ss, ts;
<a name="l00097"></a>00097                 <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;n) ns = <a class="code" href="geometry_8h.html#46448bfa3df1c2de5e3b763f163866a4">Normalize</a>(obj2world(b[0] * <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;n[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[0]] +
<a name="l00098"></a>00098                         b[1] * <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;n[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[1]] + b[2] * <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;n[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[2]]));
<a name="l00099"></a>00099                 <span class="keywordflow">else</span>   ns = dg.<a class="code" href="structDifferentialGeometry.html#1aa044f6c7b053ca460c10b0cf832c14">nn</a>;
<a name="l00100"></a>00100                 <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;s) ss = <a class="code" href="geometry_8h.html#46448bfa3df1c2de5e3b763f163866a4">Normalize</a>(obj2world(b[0] * <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;s[v[0]] +
<a name="l00101"></a>00101                         b[1] * <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;s[v[1]] + b[2] * <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;s[v[2]]));
<a name="l00102"></a>00102                 <span class="keywordflow">else</span>   ss = <a class="code" href="geometry_8h.html#46448bfa3df1c2de5e3b763f163866a4">Normalize</a>(dg.<a class="code" href="structDifferentialGeometry.html#e43d9aa60e973454b9f75800a09027da">dpdu</a>);
<a name="l00103"></a>00103                 ts = <a class="code" href="geometry_8h.html#46448bfa3df1c2de5e3b763f163866a4">Normalize</a>(<a class="code" href="geometry_8h.html#340d6d877ba46443c9ad20e7c0d0668f">Cross</a>(ss, ns));
<a name="l00104"></a>00104                 ss = <a class="code" href="geometry_8h.html#340d6d877ba46443c9ad20e7c0d0668f">Cross</a>(ts, ns);
<a name="l00105"></a>00105                 <a class="code" href="classVector.html">Vector</a> dndu, dndv;
<a name="l00106"></a>00106                 <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;n) {
<a name="l00107"></a>00107                         <span class="comment">// Compute \dndu and \dndv for triangle shading geometry</span>
<a name="l00108"></a>00108                         <span class="keywordtype">float</span> uvs[3][2];
<a name="l00109"></a>00109                         <a class="code" href="classTriangle.html#16a1dfa4d0a70aaff42e0bddb99931ca">GetUVs</a>(uvs);
<a name="l00110"></a>00110                         <span class="comment">// Compute deltas for triangle partial derivatives of normal</span>
<a name="l00111"></a>00111                         <span class="keywordtype">float</span> du1 = uvs[0][0] - uvs[2][0];
<a name="l00112"></a>00112                         <span class="keywordtype">float</span> du2 = uvs[1][0] - uvs[2][0];
<a name="l00113"></a>00113                         <span class="keywordtype">float</span> dv1 = uvs[0][1] - uvs[2][1];
<a name="l00114"></a>00114                         <span class="keywordtype">float</span> dv2 = uvs[1][1] - uvs[2][1];
<a name="l00115"></a>00115                         <a class="code" href="classVector.html">Vector</a> dn1 = <a class="code" href="classVector.html">Vector</a>(<a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;n[v[0]] - <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;n[v[2]]);
<a name="l00116"></a>00116                         <a class="code" href="classVector.html">Vector</a> dn2 = <a class="code" href="classVector.html">Vector</a>(<a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;n[v[1]] - <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;n[v[2]]);
<a name="l00117"></a>00117                         <span class="keywordtype">float</span> determinant = du1 * dv2 - dv1 * du2;
<a name="l00118"></a>00118                         <span class="keywordflow">if</span> (determinant == 0)
<a name="l00119"></a>00119                                 dndu = dndv = <a class="code" href="classVector.html">Vector</a>(0,0,0);
<a name="l00120"></a>00120                         <span class="keywordflow">else</span> {
<a name="l00121"></a>00121                                 <span class="keywordtype">float</span> invdet = 1.f / determinant;
<a name="l00122"></a>00122                                 dndu = ( dv2 * dn1 - dv1 * dn2) * invdet;
<a name="l00123"></a>00123                                 dndv = (-du2 * dn1 + du1 * dn2) * invdet;
<a name="l00124"></a>00124                         }
<a name="l00125"></a>00125                 }
<a name="l00126"></a>00126                 <span class="keywordflow">else</span>
<a name="l00127"></a>00127                         dndu = dndv = <a class="code" href="classVector.html">Vector</a>(0,0,0);
<a name="l00128"></a>00128                 *dgShading = <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a>(dg.<a class="code" href="structDifferentialGeometry.html#3d5353db1c1a6a93ef6da642d064f46e">p</a>, ss, ts,
<a name="l00129"></a>00129                         <a class="code" href="classShape.html#7c8a34f400c3a5ad7cfd2395836cda03">ObjectToWorld</a>(dndu), <a class="code" href="classShape.html#7c8a34f400c3a5ad7cfd2395836cda03">ObjectToWorld</a>(dndv), dg.<a class="code" href="structDifferentialGeometry.html#25fb75c2f13a530489cd1776171d3736">u</a>, dg.<a class="code" href="structDifferentialGeometry.html#ad45a8e22d41f9c7116211c3f2372550">v</a>, dg.<a class="code" href="structDifferentialGeometry.html#19d1f0afce45c99fef89a02f31ecbf82">shape</a>);
<a name="l00130"></a>00130                 dgShading-&gt;<a class="code" href="structDifferentialGeometry.html#ee263cfa99de799c049e33b552ff0b82">dudx</a> = dg.<a class="code" href="structDifferentialGeometry.html#ee263cfa99de799c049e33b552ff0b82">dudx</a>;  dgShading-&gt;<a class="code" href="structDifferentialGeometry.html#f0d770bd2370babb99b4eda972a757e2">dvdx</a> = dg.<a class="code" href="structDifferentialGeometry.html#f0d770bd2370babb99b4eda972a757e2">dvdx</a>; <span class="comment">// NOBOOK</span>
<a name="l00131"></a>00131                 dgShading-&gt;<a class="code" href="structDifferentialGeometry.html#57f8e45c2aa405802f25f1921ba27edd">dudy</a> = dg.<a class="code" href="structDifferentialGeometry.html#57f8e45c2aa405802f25f1921ba27edd">dudy</a>;  dgShading-&gt;<a class="code" href="structDifferentialGeometry.html#7343b4a399c5001c92fad44696060142">dvdy</a> = dg.<a class="code" href="structDifferentialGeometry.html#7343b4a399c5001c92fad44696060142">dvdy</a>; <span class="comment">// NOBOOK</span>
<a name="l00132"></a>00132                 dgShading-&gt;<a class="code" href="structDifferentialGeometry.html#307387af96b1b7a98358ea448114d697">dpdx</a> = dg.<a class="code" href="structDifferentialGeometry.html#307387af96b1b7a98358ea448114d697">dpdx</a>;  dgShading-&gt;<a class="code" href="structDifferentialGeometry.html#d3e6794a920835d56713b3659437fc00">dpdy</a> = dg.<a class="code" href="structDifferentialGeometry.html#d3e6794a920835d56713b3659437fc00">dpdy</a>; <span class="comment">// NOBOOK</span>
<a name="l00133"></a>00133         }
<a name="l00134"></a>00134         <a class="code" href="classPoint.html">Point</a> <a class="code" href="classTriangle.html#9f25a7c0b42fbf44507900a8a53dabac">Sample</a>(<span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <a class="code" href="classNormal.html">Normal</a> *Ns) <span class="keyword">const</span>;
<a name="l00135"></a>00135 <span class="keyword">private</span>:
<a name="l00136"></a>00136         <span class="comment">// Triangle Data</span>
<a name="l00137"></a><a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">00137</a>         <a class="code" href="classReference.html">Reference&lt;TriangleMesh&gt;</a> <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>;
<a name="l00138"></a><a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">00138</a>         <span class="keywordtype">int</span> *<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>;
<a name="l00139"></a>00139 };
<a name="l00140"></a>00140 <span class="comment">// TriangleMesh Method Definitions</span>
<a name="l00141"></a><a class="code" href="classTriangleMesh.html#6db6aa1e1ecc4de8ea00135faf3c0894">00141</a> <a class="code" href="classTriangleMesh.html#6db6aa1e1ecc4de8ea00135faf3c0894">TriangleMesh::TriangleMesh</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;o2w, <span class="keywordtype">bool</span> ro,
<a name="l00142"></a>00142                 <span class="keywordtype">int</span> nt, <span class="keywordtype">int</span> nv, <span class="keyword">const</span> <span class="keywordtype">int</span> *vi, <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> *P,
<a name="l00143"></a>00143                 <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> *<a class="code" href="util_8cpp.html#0240ac851181b84ac374872dc5434ee4">N</a>, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> *S, <span class="keyword">const</span> <span class="keywordtype">float</span> *uv)
<a name="l00144"></a>00144         : <a class="code" href="classShape.html">Shape</a>(o2w, ro) {
<a name="l00145"></a>00145         <a class="code" href="classTriangleMesh.html#34fc75652396b91479ffe2cc0596bea4">ntris</a> = nt;
<a name="l00146"></a>00146         <a class="code" href="classTriangleMesh.html#965bd9d2dfd9e10768dc19c53f77726d">nverts</a> = nv;
<a name="l00147"></a>00147         <a class="code" href="classTriangleMesh.html#4bd96a5a81338f923be058ea90cd4dfe">vertexIndex</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[3 * <a class="code" href="classTriangleMesh.html#34fc75652396b91479ffe2cc0596bea4">ntris</a>];
<a name="l00148"></a>00148         <a class="code" href="pbrtparse_8y.html#2ac249754cc680184bc1b7825aacb876">memcpy</a>(<a class="code" href="classTriangleMesh.html#4bd96a5a81338f923be058ea90cd4dfe">vertexIndex</a>, vi, 3 * <a class="code" href="classTriangleMesh.html#34fc75652396b91479ffe2cc0596bea4">ntris</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00149"></a>00149         <span class="comment">// Copy _uv_, _N_, and _S_ vertex data, if present</span>
<a name="l00150"></a>00150         <span class="keywordflow">if</span> (uv) {
<a name="l00151"></a>00151                 <a class="code" href="classTriangleMesh.html#499d9df5fe9b544ff03f8f79e7a83113">uvs</a> = <span class="keyword">new</span> <span class="keywordtype">float</span>[2*<a class="code" href="classTriangleMesh.html#965bd9d2dfd9e10768dc19c53f77726d">nverts</a>];
<a name="l00152"></a>00152                 <a class="code" href="pbrtparse_8y.html#2ac249754cc680184bc1b7825aacb876">memcpy</a>(<a class="code" href="classTriangleMesh.html#499d9df5fe9b544ff03f8f79e7a83113">uvs</a>, uv, 2*<a class="code" href="classTriangleMesh.html#965bd9d2dfd9e10768dc19c53f77726d">nverts</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00153"></a>00153         }
<a name="l00154"></a>00154         <span class="keywordflow">else</span> <a class="code" href="classTriangleMesh.html#499d9df5fe9b544ff03f8f79e7a83113">uvs</a> = NULL;
<a name="l00155"></a>00155         <a class="code" href="classTriangleMesh.html#c29b8860d6b8b1c55adc600be837f016">p</a> = <span class="keyword">new</span> <a class="code" href="classPoint.html">Point</a>[<a class="code" href="classTriangleMesh.html#965bd9d2dfd9e10768dc19c53f77726d">nverts</a>];
<a name="l00156"></a>00156         <span class="keywordflow">if</span> (N) {
<a name="l00157"></a>00157                 <a class="code" href="classTriangleMesh.html#488610e36c82f45af88a585f961d8885">n</a> = <span class="keyword">new</span> <a class="code" href="classNormal.html">Normal</a>[<a class="code" href="classTriangleMesh.html#965bd9d2dfd9e10768dc19c53f77726d">nverts</a>];
<a name="l00158"></a>00158                 <a class="code" href="pbrtparse_8y.html#2ac249754cc680184bc1b7825aacb876">memcpy</a>(<a class="code" href="classTriangleMesh.html#488610e36c82f45af88a585f961d8885">n</a>, N, <a class="code" href="classTriangleMesh.html#965bd9d2dfd9e10768dc19c53f77726d">nverts</a>*<span class="keyword">sizeof</span>(<a class="code" href="classNormal.html">Normal</a>));
<a name="l00159"></a>00159         }
<a name="l00160"></a>00160         <span class="keywordflow">else</span> <a class="code" href="classTriangleMesh.html#488610e36c82f45af88a585f961d8885">n</a> = NULL;
<a name="l00161"></a>00161         <span class="keywordflow">if</span> (S) {
<a name="l00162"></a>00162                 <a class="code" href="classTriangleMesh.html#bdbdc2862be701d2880802aa43719fab">s</a> = <span class="keyword">new</span> <a class="code" href="classVector.html">Vector</a>[<a class="code" href="classTriangleMesh.html#965bd9d2dfd9e10768dc19c53f77726d">nverts</a>];
<a name="l00163"></a>00163                 <a class="code" href="pbrtparse_8y.html#2ac249754cc680184bc1b7825aacb876">memcpy</a>(<a class="code" href="classTriangleMesh.html#bdbdc2862be701d2880802aa43719fab">s</a>, S, <a class="code" href="classTriangleMesh.html#965bd9d2dfd9e10768dc19c53f77726d">nverts</a>*<span class="keyword">sizeof</span>(<a class="code" href="classVector.html">Vector</a>));
<a name="l00164"></a>00164         }
<a name="l00165"></a>00165         <span class="keywordflow">else</span> <a class="code" href="classTriangleMesh.html#bdbdc2862be701d2880802aa43719fab">s</a> = NULL;
<a name="l00166"></a>00166         <span class="comment">// Transform mesh vertices to world space</span>
<a name="l00167"></a>00167         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i  = 0; i &lt; <a class="code" href="classTriangleMesh.html#965bd9d2dfd9e10768dc19c53f77726d">nverts</a>; ++i)
<a name="l00168"></a>00168                 <a class="code" href="classTriangleMesh.html#c29b8860d6b8b1c55adc600be837f016">p</a>[i] = <a class="code" href="classShape.html#7c8a34f400c3a5ad7cfd2395836cda03">ObjectToWorld</a>(P[i]);
<a name="l00169"></a>00169 }
<a name="l00170"></a><a class="code" href="classTriangleMesh.html#d2e6daebfd73b0f3cf832b13a2bf300d">00170</a> <a class="code" href="classTriangleMesh.html#d2e6daebfd73b0f3cf832b13a2bf300d">TriangleMesh::~TriangleMesh</a>() {
<a name="l00171"></a>00171         <span class="keyword">delete</span>[] <a class="code" href="classTriangleMesh.html#4bd96a5a81338f923be058ea90cd4dfe">vertexIndex</a>;
<a name="l00172"></a>00172         <span class="keyword">delete</span>[] <a class="code" href="classTriangleMesh.html#c29b8860d6b8b1c55adc600be837f016">p</a>;
<a name="l00173"></a>00173         <span class="keyword">delete</span>[] <a class="code" href="classTriangleMesh.html#bdbdc2862be701d2880802aa43719fab">s</a>;
<a name="l00174"></a>00174         <span class="keyword">delete</span>[] <a class="code" href="classTriangleMesh.html#488610e36c82f45af88a585f961d8885">n</a>;
<a name="l00175"></a>00175         <span class="keyword">delete</span>[] <a class="code" href="classTriangleMesh.html#499d9df5fe9b544ff03f8f79e7a83113">uvs</a>;
<a name="l00176"></a>00176 }
<a name="l00177"></a><a class="code" href="classTriangleMesh.html#79f842f87641104c22d08a3e3ec4ca96">00177</a> <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classTriangleMesh.html#79f842f87641104c22d08a3e3ec4ca96">TriangleMesh::ObjectBound</a>()<span class="keyword"> const </span>{
<a name="l00178"></a>00178         <a class="code" href="classBBox.html">BBox</a> bobj;
<a name="l00179"></a>00179         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classTriangleMesh.html#965bd9d2dfd9e10768dc19c53f77726d">nverts</a>; i++)
<a name="l00180"></a>00180                 bobj = <a class="code" href="geometry_8cpp.html#b6b355a05ae9130aceaa5ed34f3eb75b">Union</a>(bobj, <a class="code" href="classShape.html#72cf45b4c359fc22b3264a02e932324e">WorldToObject</a>(<a class="code" href="classTriangleMesh.html#c29b8860d6b8b1c55adc600be837f016">p</a>[i]));
<a name="l00181"></a>00181         <span class="keywordflow">return</span> bobj;
<a name="l00182"></a>00182 }
<a name="l00183"></a><a class="code" href="classTriangleMesh.html#6d9bcc0ccb5c431c2ce0a07ad00c9781">00183</a> <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classTriangleMesh.html#6d9bcc0ccb5c431c2ce0a07ad00c9781">TriangleMesh::WorldBound</a>()<span class="keyword"> const </span>{
<a name="l00184"></a>00184         <a class="code" href="classBBox.html">BBox</a> worldBounds;
<a name="l00185"></a>00185         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classTriangleMesh.html#965bd9d2dfd9e10768dc19c53f77726d">nverts</a>; i++)
<a name="l00186"></a>00186                 worldBounds = <a class="code" href="geometry_8cpp.html#b6b355a05ae9130aceaa5ed34f3eb75b">Union</a>(worldBounds, <a class="code" href="classTriangleMesh.html#c29b8860d6b8b1c55adc600be837f016">p</a>[i]);
<a name="l00187"></a>00187         <span class="keywordflow">return</span> worldBounds;
<a name="l00188"></a>00188 }
<a name="l00189"></a>00189 <span class="keywordtype">void</span>
<a name="l00190"></a><a class="code" href="classTriangleMesh.html#60c339321ae481e2be159ffe53150bd9">00190</a> <a class="code" href="classTriangleMesh.html#60c339321ae481e2be159ffe53150bd9">TriangleMesh::Refine</a>(vector&lt;<a class="code" href="classReference.html">Reference&lt;Shape&gt;</a> &gt; &amp;refined)<span class="keyword"></span>
<a name="l00191"></a>00191 <span class="keyword">const </span>{
<a name="l00192"></a>00192         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classTriangleMesh.html#34fc75652396b91479ffe2cc0596bea4">ntris</a>; ++i)
<a name="l00193"></a>00193                 refined.push_back(<span class="keyword">new</span> <a class="code" href="classTriangle.html">Triangle</a>(<a class="code" href="classShape.html#7c8a34f400c3a5ad7cfd2395836cda03">ObjectToWorld</a>,
<a name="l00194"></a>00194                                                <a class="code" href="classShape.html#337c63db30f17a31ac81a8921ec97872">reverseOrientation</a>,
<a name="l00195"></a>00195                                        (<a class="code" href="classTriangleMesh.html">TriangleMesh</a> *)<span class="keyword">this</span>,
<a name="l00196"></a>00196                                                                            i));
<a name="l00197"></a>00197 }
<a name="l00198"></a><a class="code" href="classTriangle.html#5b81f9acac2c513b82e0df8a98a3ce3d">00198</a> <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classTriangle.html#5b81f9acac2c513b82e0df8a98a3ce3d">Triangle::ObjectBound</a>()<span class="keyword"> const </span>{
<a name="l00199"></a>00199         <span class="comment">// Get triangle vertices in _p1_, _p2_, and _p3_</span>
<a name="l00200"></a>00200         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p1 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[0]];
<a name="l00201"></a>00201         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p2 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[1]];
<a name="l00202"></a>00202         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p3 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[2]];
<a name="l00203"></a>00203         <span class="keywordflow">return</span> <a class="code" href="geometry_8cpp.html#b6b355a05ae9130aceaa5ed34f3eb75b">Union</a>(<a class="code" href="classBBox.html">BBox</a>(<a class="code" href="classShape.html#72cf45b4c359fc22b3264a02e932324e">WorldToObject</a>(p1), <a class="code" href="classShape.html#72cf45b4c359fc22b3264a02e932324e">WorldToObject</a>(p2)),
<a name="l00204"></a>00204                 <a class="code" href="classShape.html#72cf45b4c359fc22b3264a02e932324e">WorldToObject</a>(p3));
<a name="l00205"></a>00205 }
<a name="l00206"></a><a class="code" href="classTriangle.html#71c6c6faae282bb1166458360a9b3382">00206</a> <a class="code" href="classBBox.html">BBox</a> <a class="code" href="classTriangle.html#71c6c6faae282bb1166458360a9b3382">Triangle::WorldBound</a>()<span class="keyword"> const </span>{
<a name="l00207"></a>00207         <span class="comment">// Get triangle vertices in _p1_, _p2_, and _p3_</span>
<a name="l00208"></a>00208         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p1 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[0]];
<a name="l00209"></a>00209         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p2 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[1]];
<a name="l00210"></a>00210         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p3 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[2]];
<a name="l00211"></a>00211         <span class="keywordflow">return</span> <a class="code" href="geometry_8cpp.html#b6b355a05ae9130aceaa5ed34f3eb75b">Union</a>(<a class="code" href="classBBox.html">BBox</a>(p1, p2), p3);
<a name="l00212"></a>00212 }
<a name="l00213"></a><a class="code" href="classTriangle.html#b801413505392b1bb09fc1e0069f7754">00213</a> <span class="keywordtype">bool</span> <a class="code" href="classTriangle.html#b801413505392b1bb09fc1e0069f7754">Triangle::Intersect</a>(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray, <span class="keywordtype">float</span> *tHit,
<a name="l00214"></a>00214                 <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a> *dg)<span class="keyword"> const </span>{
<a name="l00215"></a>00215         <span class="comment">// Initialize triangle intersection statistics</span>
<a name="l00216"></a>00216         <span class="keyword">static</span>
<a name="l00217"></a>00217         <a class="code" href="classStatsPercentage.html">StatsPercentage</a> triangleHits(<span class="stringliteral">"Geometry"</span>,
<a name="l00218"></a>00218                                      <span class="stringliteral">"Triangle Ray Intersections"</span>);
<a name="l00219"></a>00219         <span class="comment">// Update triangle tests count</span>
<a name="l00220"></a>00220         triangleHits.<a class="code" href="classStatsPercentage.html#4102f83517e7ab0bcc92437fde4b72fe">Add</a>(0, 1);
<a name="l00221"></a>00221         <span class="comment">// Compute $\VEC{s}_1$</span>
<a name="l00222"></a>00222         <span class="comment">// Get triangle vertices in _p1_, _p2_, and _p3_</span>
<a name="l00223"></a>00223         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p1 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[0]];
<a name="l00224"></a>00224         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p2 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[1]];
<a name="l00225"></a>00225         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p3 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[2]];
<a name="l00226"></a>00226         <a class="code" href="classVector.html">Vector</a> e1 = p2 - p1;
<a name="l00227"></a>00227         <a class="code" href="classVector.html">Vector</a> e2 = p3 - p1;
<a name="l00228"></a>00228         <a class="code" href="classVector.html">Vector</a> s1 = <a class="code" href="geometry_8h.html#340d6d877ba46443c9ad20e7c0d0668f">Cross</a>(ray.<a class="code" href="classRay.html#5bbfc94e178e0a050b51200acc579069">d</a>, e2);
<a name="l00229"></a>00229         <span class="keywordtype">float</span> divisor = <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(s1, e1);
<a name="l00230"></a>00230         <span class="keywordflow">if</span> (divisor == 0.)
<a name="l00231"></a>00231                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00232"></a>00232         <span class="keywordtype">float</span> invDivisor = 1.f / divisor;
<a name="l00233"></a>00233         <span class="comment">// Compute first barycentric coordinate</span>
<a name="l00234"></a>00234         <a class="code" href="classVector.html">Vector</a> d = ray.<a class="code" href="classRay.html#1014d000992e8ac3b92f150ad2a5cffe">o</a> - p1;
<a name="l00235"></a>00235         <span class="keywordtype">float</span> b1 = <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(d, s1) * invDivisor;
<a name="l00236"></a>00236         <span class="keywordflow">if</span> (b1 &lt; 0. || b1 &gt; 1.)
<a name="l00237"></a>00237                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00238"></a>00238         <span class="comment">// Compute second barycentric coordinate</span>
<a name="l00239"></a>00239         <a class="code" href="classVector.html">Vector</a> s2 = <a class="code" href="geometry_8h.html#340d6d877ba46443c9ad20e7c0d0668f">Cross</a>(d, e1);
<a name="l00240"></a>00240         <span class="keywordtype">float</span> b2 = <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(ray.<a class="code" href="classRay.html#5bbfc94e178e0a050b51200acc579069">d</a>, s2) * invDivisor;
<a name="l00241"></a>00241         <span class="keywordflow">if</span> (b2 &lt; 0. || b1 + b2 &gt; 1.)
<a name="l00242"></a>00242                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00243"></a>00243         <span class="comment">// Compute _t_ to intersection point</span>
<a name="l00244"></a>00244         <span class="keywordtype">float</span> t = <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(e2, s2) * invDivisor;
<a name="l00245"></a>00245         <span class="keywordflow">if</span> (t &lt; ray.mint || t &gt; ray.<a class="code" href="classRay.html#aa6c29ceae8edc5c9d37e879daa1557a">maxt</a>)
<a name="l00246"></a>00246                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00247"></a>00247         triangleHits.<a class="code" href="classStatsPercentage.html#4102f83517e7ab0bcc92437fde4b72fe">Add</a>(1, 0); <span class="comment">//NOBOOK</span>
<a name="l00248"></a>00248         <span class="comment">// Fill in _DifferentialGeometry_ from triangle hit</span>
<a name="l00249"></a>00249         <span class="comment">// Compute triangle partial derivatives</span>
<a name="l00250"></a>00250         <a class="code" href="classVector.html">Vector</a> dpdu, dpdv;
<a name="l00251"></a>00251         <span class="keywordtype">float</span> uvs[3][2];
<a name="l00252"></a>00252         <a class="code" href="classTriangle.html#16a1dfa4d0a70aaff42e0bddb99931ca">GetUVs</a>(uvs);
<a name="l00253"></a>00253         <span class="comment">// Compute deltas for triangle partial derivatives</span>
<a name="l00254"></a>00254         <span class="keywordtype">float</span> du1 = uvs[0][0] - uvs[2][0];
<a name="l00255"></a>00255         <span class="keywordtype">float</span> du2 = uvs[1][0] - uvs[2][0];
<a name="l00256"></a>00256         <span class="keywordtype">float</span> dv1 = uvs[0][1] - uvs[2][1];
<a name="l00257"></a>00257         <span class="keywordtype">float</span> dv2 = uvs[1][1] - uvs[2][1];
<a name="l00258"></a>00258         <a class="code" href="classVector.html">Vector</a> dp1 = p1 - p3, dp2 = p2 - p3;
<a name="l00259"></a>00259         <span class="keywordtype">float</span> determinant = du1 * dv2 - dv1 * du2;
<a name="l00260"></a>00260         <span class="keywordflow">if</span> (determinant == 0.f) {
<a name="l00261"></a>00261                 <span class="comment">// Handle zero determinant for triangle partial derivative matrix</span>
<a name="l00262"></a>00262                 <a class="code" href="geometry_8h.html#031e7585a4def8a8496acb37db87adca">CoordinateSystem</a>(<a class="code" href="geometry_8h.html#46448bfa3df1c2de5e3b763f163866a4">Normalize</a>(<a class="code" href="geometry_8h.html#340d6d877ba46443c9ad20e7c0d0668f">Cross</a>(e2, e1)), &amp;dpdu, &amp;dpdv);
<a name="l00263"></a>00263         }
<a name="l00264"></a>00264         <span class="keywordflow">else</span> {
<a name="l00265"></a>00265                 <span class="keywordtype">float</span> invdet = 1.f / determinant;
<a name="l00266"></a>00266                 dpdu = ( dv2 * dp1 - dv1 * dp2) * invdet;
<a name="l00267"></a>00267                 dpdv = (-du2 * dp1 + du1 * dp2) * invdet;
<a name="l00268"></a>00268         }
<a name="l00269"></a>00269         <span class="comment">// Interpolate $(u,v)$ triangle parametric coordinates</span>
<a name="l00270"></a>00270         <span class="keywordtype">float</span> b0 = 1 - b1 - b2;
<a name="l00271"></a>00271         <span class="keywordtype">float</span> tu = b0*uvs[0][0] + b1*uvs[1][0] + b2*uvs[2][0];
<a name="l00272"></a>00272         <span class="keywordtype">float</span> tv = b0*uvs[0][1] + b1*uvs[1][1] + b2*uvs[2][1];
<a name="l00273"></a>00273         *dg = <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a>(ray(t), dpdu, dpdv,
<a name="l00274"></a>00274                                    <a class="code" href="classVector.html">Vector</a>(0,0,0), <a class="code" href="classVector.html">Vector</a>(0,0,0),
<a name="l00275"></a>00275                                                            tu, tv, <span class="keyword">this</span>);
<a name="l00276"></a>00276         *tHit = t;
<a name="l00277"></a>00277         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00278"></a>00278 }
<a name="l00279"></a><a class="code" href="classTriangle.html#ff98443b083b9c464d687324c7b41e9d">00279</a> <span class="keywordtype">bool</span> <a class="code" href="classTriangle.html#ff98443b083b9c464d687324c7b41e9d">Triangle::IntersectP</a>(<span class="keyword">const</span> <a class="code" href="classRay.html">Ray</a> &amp;ray)<span class="keyword"> const </span>{
<a name="l00280"></a>00280         <span class="comment">// Initialize triangle intersection statistics</span>
<a name="l00281"></a>00281         <span class="keyword">static</span>
<a name="l00282"></a>00282         <a class="code" href="classStatsPercentage.html">StatsPercentage</a> triangleHits(<span class="stringliteral">"Geometry"</span>,
<a name="l00283"></a>00283                                      <span class="stringliteral">"Triangle Ray Intersections"</span>);
<a name="l00284"></a>00284         <span class="comment">// Update triangle tests count</span>
<a name="l00285"></a>00285         triangleHits.<a class="code" href="classStatsPercentage.html#4102f83517e7ab0bcc92437fde4b72fe">Add</a>(0, 1);
<a name="l00286"></a>00286         <span class="comment">// Compute $\VEC{s}_1$</span>
<a name="l00287"></a>00287         <span class="comment">// Get triangle vertices in _p1_, _p2_, and _p3_</span>
<a name="l00288"></a>00288         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p1 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[0]];
<a name="l00289"></a>00289         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p2 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[1]];
<a name="l00290"></a>00290         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p3 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[2]];
<a name="l00291"></a>00291         <a class="code" href="classVector.html">Vector</a> e1 = p2 - p1;
<a name="l00292"></a>00292         <a class="code" href="classVector.html">Vector</a> e2 = p3 - p1;
<a name="l00293"></a>00293         <a class="code" href="classVector.html">Vector</a> s1 = <a class="code" href="geometry_8h.html#340d6d877ba46443c9ad20e7c0d0668f">Cross</a>(ray.<a class="code" href="classRay.html#5bbfc94e178e0a050b51200acc579069">d</a>, e2);
<a name="l00294"></a>00294         <span class="keywordtype">float</span> divisor = <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(s1, e1);
<a name="l00295"></a>00295         <span class="keywordflow">if</span> (divisor == 0.)
<a name="l00296"></a>00296                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00297"></a>00297         <span class="keywordtype">float</span> invDivisor = 1.f / divisor;
<a name="l00298"></a>00298         <span class="comment">// Compute first barycentric coordinate</span>
<a name="l00299"></a>00299         <a class="code" href="classVector.html">Vector</a> d = ray.<a class="code" href="classRay.html#1014d000992e8ac3b92f150ad2a5cffe">o</a> - p1;
<a name="l00300"></a>00300         <span class="keywordtype">float</span> b1 = <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(d, s1) * invDivisor;
<a name="l00301"></a>00301         <span class="keywordflow">if</span> (b1 &lt; 0. || b1 &gt; 1.)
<a name="l00302"></a>00302                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00303"></a>00303         <span class="comment">// Compute second barycentric coordinate</span>
<a name="l00304"></a>00304         <a class="code" href="classVector.html">Vector</a> s2 = <a class="code" href="geometry_8h.html#340d6d877ba46443c9ad20e7c0d0668f">Cross</a>(d, e1);
<a name="l00305"></a>00305         <span class="keywordtype">float</span> b2 = <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(ray.<a class="code" href="classRay.html#5bbfc94e178e0a050b51200acc579069">d</a>, s2) * invDivisor;
<a name="l00306"></a>00306         <span class="keywordflow">if</span> (b2 &lt; 0. || b1 + b2 &gt; 1.)
<a name="l00307"></a>00307                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00308"></a>00308         <span class="comment">// Compute _t_ to intersection point</span>
<a name="l00309"></a>00309         <span class="keywordtype">float</span> t = <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(e2, s2) * invDivisor;
<a name="l00310"></a>00310         <span class="keywordflow">if</span> (t &lt; ray.mint || t &gt; ray.<a class="code" href="classRay.html#aa6c29ceae8edc5c9d37e879daa1557a">maxt</a>)
<a name="l00311"></a>00311                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00312"></a>00312         triangleHits.<a class="code" href="classStatsPercentage.html#4102f83517e7ab0bcc92437fde4b72fe">Add</a>(1, 0); <span class="comment">//NOBOOK</span>
<a name="l00313"></a>00313         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00314"></a>00314 }
<a name="l00315"></a><a class="code" href="classTriangle.html#16a1dfa4d0a70aaff42e0bddb99931ca">00315</a> <span class="keywordtype">void</span> <a class="code" href="classTriangle.html#16a1dfa4d0a70aaff42e0bddb99931ca">Triangle::GetUVs</a>(<span class="keywordtype">float</span> uv[3][2])<span class="keyword"> const </span>{
<a name="l00316"></a>00316         <span class="keywordflow">if</span> (<a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;uvs) {
<a name="l00317"></a>00317                 uv[0][0] = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;uvs[2*<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[0]];
<a name="l00318"></a>00318                 uv[0][1] = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;uvs[2*<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[0]+1];
<a name="l00319"></a>00319                 uv[1][0] = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;uvs[2*<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[1]];
<a name="l00320"></a>00320                 uv[1][1] = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;uvs[2*<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[1]+1];
<a name="l00321"></a>00321                 uv[2][0] = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;uvs[2*<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[2]];
<a name="l00322"></a>00322                 uv[2][1] = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;uvs[2*<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[2]+1];
<a name="l00323"></a>00323         } <span class="keywordflow">else</span> {
<a name="l00324"></a>00324                 uv[0][0] = 0.; uv[0][1] = 0.;
<a name="l00325"></a>00325                 uv[1][0] = 1.; uv[1][1] = 0.;
<a name="l00326"></a>00326                 uv[2][0] = 1.; uv[2][1] = 1.;
<a name="l00327"></a>00327         }
<a name="l00328"></a>00328 }
<a name="l00329"></a><a class="code" href="classTriangle.html#d3885c40e78c33327a622351dbb07ed7">00329</a> <span class="keywordtype">float</span> <a class="code" href="classTriangle.html#d3885c40e78c33327a622351dbb07ed7">Triangle::Area</a>()<span class="keyword"> const </span>{
<a name="l00330"></a>00330         <span class="comment">// Get triangle vertices in _p1_, _p2_, and _p3_</span>
<a name="l00331"></a>00331         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p1 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[0]];
<a name="l00332"></a>00332         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p2 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[1]];
<a name="l00333"></a>00333         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p3 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[2]];
<a name="l00334"></a>00334         <span class="keywordflow">return</span> 0.5f * <a class="code" href="geometry_8h.html#340d6d877ba46443c9ad20e7c0d0668f">Cross</a>(p2-p1, p3-p1).<a class="code" href="classVector.html#e543b9efc35a284a41dea4aeca593d51">Length</a>();
<a name="l00335"></a>00335 }
<a name="l00336"></a><a class="code" href="classTriangle.html#9f25a7c0b42fbf44507900a8a53dabac">00336</a> <a class="code" href="classPoint.html">Point</a> <a class="code" href="classTriangle.html#9f25a7c0b42fbf44507900a8a53dabac">Triangle::Sample</a>(<span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2,
<a name="l00337"></a>00337                 <a class="code" href="classNormal.html">Normal</a> *Ns)<span class="keyword"> const </span>{
<a name="l00338"></a>00338         <span class="keywordtype">float</span> b1, b2;
<a name="l00339"></a>00339         <a class="code" href="mc_8cpp.html#b268bd5ca56bf19d12051a1f36f1b4d1">UniformSampleTriangle</a>(u1, u2, &amp;b1, &amp;b2);
<a name="l00340"></a>00340         <span class="comment">// Get triangle vertices in _p1_, _p2_, and _p3_</span>
<a name="l00341"></a>00341         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p1 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[0]];
<a name="l00342"></a>00342         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p2 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[1]];
<a name="l00343"></a>00343         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> &amp;p3 = <a class="code" href="classTriangle.html#f9e2246567ba6f7ac680d3b8880f0453">mesh</a>-&gt;p[<a class="code" href="classTriangle.html#fcc94157c90fae1ad520e80a0c59dd78">v</a>[2]];
<a name="l00344"></a>00344         <a class="code" href="classPoint.html">Point</a> p = b1 * p1 + b2 * p2 + (1.f - b1 - b2) * p3;
<a name="l00345"></a>00345         <a class="code" href="classNormal.html">Normal</a> n = <a class="code" href="classNormal.html">Normal</a>(<a class="code" href="geometry_8h.html#340d6d877ba46443c9ad20e7c0d0668f">Cross</a>(p2-p1, p3-p1));
<a name="l00346"></a>00346         *Ns = <a class="code" href="geometry_8h.html#46448bfa3df1c2de5e3b763f163866a4">Normalize</a>(n);
<a name="l00347"></a>00347         <span class="keywordflow">if</span> (<a class="code" href="classShape.html#337c63db30f17a31ac81a8921ec97872">reverseOrientation</a>) *Ns *= -1.f;
<a name="l00348"></a>00348         <span class="keywordflow">return</span> p;
<a name="l00349"></a>00349 }
<a name="l00350"></a><a class="code" href="trianglemesh_8cpp.html#3ca5abc6928b2220103b7f077e0471e1">00350</a> <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <a class="code" href="pbrt_8h.html#808e08638be3cba36e36759e5b150de0">DLLEXPORT</a> <a class="code" href="classShape.html">Shape</a> *<a class="code" href="cone_8cpp.html#3ca5abc6928b2220103b7f077e0471e1">CreateShape</a>(<span class="keyword">const</span> <a class="code" href="classTransform.html">Transform</a> &amp;o2w,
<a name="l00351"></a>00351                 <span class="keywordtype">bool</span> <a class="code" href="classShape.html#337c63db30f17a31ac81a8921ec97872">reverseOrientation</a>, <span class="keyword">const</span> <a class="code" href="classParamSet.html">ParamSet</a> &amp;params) {
<a name="l00352"></a>00352         <span class="keywordtype">int</span> nvi, npi, nuvi, nsi, nni;
<a name="l00353"></a>00353         <span class="keyword">const</span> <span class="keywordtype">int</span> *vi = params.<a class="code" href="classParamSet.html#0eedca764a18f6a71548f3daaf19e36c">FindInt</a>(<span class="stringliteral">"indices"</span>, &amp;nvi);
<a name="l00354"></a>00354         <span class="keyword">const</span> <a class="code" href="classPoint.html">Point</a> *P = params.<a class="code" href="classParamSet.html#c81cf4c6ee0c96d7b6df73f4a65d86f0">FindPoint</a>(<span class="stringliteral">"P"</span>, &amp;npi);
<a name="l00355"></a>00355         <span class="keyword">const</span> <span class="keywordtype">float</span> *uvs = params.<a class="code" href="classParamSet.html#16ef98ac9d59f839f08c13fb80eeeefe">FindFloat</a>(<span class="stringliteral">"uv"</span>, &amp;nuvi);
<a name="l00356"></a>00356         <span class="keywordflow">if</span> (!uvs) uvs = params.<a class="code" href="classParamSet.html#16ef98ac9d59f839f08c13fb80eeeefe">FindFloat</a>(<span class="stringliteral">"st"</span>, &amp;nuvi);
<a name="l00357"></a>00357         <span class="comment">// XXX should complain if uvs aren't an array of 2...</span>
<a name="l00358"></a>00358         <span class="keywordflow">if</span> (uvs) {
<a name="l00359"></a>00359                 <span class="keywordflow">if</span> (nuvi &lt; 2 * npi) {
<a name="l00360"></a>00360                         <a class="code" href="pbrt_8h.html#d1a16fc9ced4ddc376b9d3e6607be15e">Error</a>(<span class="stringliteral">"Not enough of \"uv\"s for triangle mesh.  Expencted %d, "</span>
<a name="l00361"></a>00361                               <span class="stringliteral">"found %d.  Discarding.\n"</span>, 2*npi, nuvi);
<a name="l00362"></a>00362                         uvs = NULL;
<a name="l00363"></a>00363                 }
<a name="l00364"></a>00364                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nuvi &gt; 2 * npi)
<a name="l00365"></a>00365                         <a class="code" href="pbrt_8h.html#79abc2e750c4774bd9d433ad4f6e440a">Warning</a>(<span class="stringliteral">"More \"uv\"s provided than will be used for triangle "</span>
<a name="l00366"></a>00366                                 <span class="stringliteral">"mesh.  (%d expcted, %d found)\n"</span>, 2*npi, nuvi);
<a name="l00367"></a>00367         }
<a name="l00368"></a>00368         <span class="keywordflow">if</span> (!vi || !P) <span class="keywordflow">return</span> NULL;
<a name="l00369"></a>00369         <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> *S = params.<a class="code" href="classParamSet.html#945676677ef219bcc1073b669aae8e2c">FindVector</a>(<span class="stringliteral">"S"</span>, &amp;nsi);
<a name="l00370"></a>00370         <span class="keywordflow">if</span> (S &amp;&amp; nsi != npi) {
<a name="l00371"></a>00371                 <a class="code" href="pbrt_8h.html#d1a16fc9ced4ddc376b9d3e6607be15e">Error</a>(<span class="stringliteral">"Number of \"S\"s for triangle mesh must match \"P\"s"</span>);
<a name="l00372"></a>00372                 S = NULL;
<a name="l00373"></a>00373         }
<a name="l00374"></a>00374         <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> *<a class="code" href="util_8cpp.html#0240ac851181b84ac374872dc5434ee4">N</a> = params.<a class="code" href="classParamSet.html#5690a1a0c15f7d2c7d52e30bf159e9c0">FindNormal</a>(<span class="stringliteral">"N"</span>, &amp;nni);
<a name="l00375"></a>00375         <span class="keywordflow">if</span> (N &amp;&amp; nni != npi) {
<a name="l00376"></a>00376                 <a class="code" href="pbrt_8h.html#d1a16fc9ced4ddc376b9d3e6607be15e">Error</a>(<span class="stringliteral">"Number of \"N\"s for triangle mesh must match \"P\"s"</span>);
<a name="l00377"></a>00377                 N = NULL;
<a name="l00378"></a>00378         }
<a name="l00379"></a>00379         <span class="keywordflow">if</span> (uvs &amp;&amp; N) {
<a name="l00380"></a>00380                 <span class="comment">// if there are normals, check for bad uv's that</span>
<a name="l00381"></a>00381                 <span class="comment">// give degenerate mappings; discard them if so</span>
<a name="l00382"></a>00382                 <span class="keyword">const</span> <span class="keywordtype">int</span> *vp = vi;
<a name="l00383"></a>00383                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nvi; i += 3, vp += 3) {
<a name="l00384"></a>00384                         <span class="keywordtype">float</span> area = .5f * <a class="code" href="geometry_8h.html#340d6d877ba46443c9ad20e7c0d0668f">Cross</a>(P[vp[0]]-P[vp[1]], P[vp[2]]-P[vp[1]]).<a class="code" href="classVector.html#e543b9efc35a284a41dea4aeca593d51">Length</a>();
<a name="l00385"></a>00385                         <span class="keywordflow">if</span> (area &lt; 1e-7) <span class="keywordflow">continue</span>; <span class="comment">// ignore degenerate tris.</span>
<a name="l00386"></a>00386                         <span class="keywordflow">if</span> ((uvs[2*vp[0]] == uvs[2*vp[1]] &amp;&amp;
<a name="l00387"></a>00387                                 uvs[2*vp[0]+1] == uvs[2*vp[1]+1]) ||
<a name="l00388"></a>00388                                 (uvs[2*vp[1]] == uvs[2*vp[2]] &amp;&amp;
<a name="l00389"></a>00389                                 uvs[2*vp[1]+1] == uvs[2*vp[2]+1]) ||
<a name="l00390"></a>00390                                 (uvs[2*vp[2]] == uvs[2*vp[0]] &amp;&amp;
<a name="l00391"></a>00391                                 uvs[2*vp[2]+1] == uvs[2*vp[0]+1])) {
<a name="l00392"></a>00392                                 <a class="code" href="pbrt_8h.html#79abc2e750c4774bd9d433ad4f6e440a">Warning</a>(<span class="stringliteral">"Degenerate uv coordinates in triangle mesh.  Discarding all uvs."</span>);
<a name="l00393"></a>00393                                 uvs = NULL;
<a name="l00394"></a>00394                                 <span class="keywordflow">break</span>;
<a name="l00395"></a>00395                         }
<a name="l00396"></a>00396                 }
<a name="l00397"></a>00397         }
<a name="l00398"></a>00398         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nvi; ++i)
<a name="l00399"></a>00399                 <span class="keywordflow">if</span> (vi[i] &gt;= npi) {
<a name="l00400"></a>00400                         <a class="code" href="pbrt_8h.html#d1a16fc9ced4ddc376b9d3e6607be15e">Error</a>(<span class="stringliteral">"trianglemesh has out of-bounds vertex index %d (%d \"P\" values were given"</span>,
<a name="l00401"></a>00401                                 vi[i], npi);
<a name="l00402"></a>00402                         <span class="keywordflow">return</span> NULL;
<a name="l00403"></a>00403                 }
<a name="l00404"></a>00404         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classTriangleMesh.html">TriangleMesh</a>(o2w, reverseOrientation, nvi/3, npi, vi, P,
<a name="l00405"></a>00405                 N, S, uvs);
<a name="l00406"></a>00406 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Jul 20 17:31:53 2009 for pbrt by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
