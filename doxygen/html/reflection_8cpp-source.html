<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>pbrt: reflection.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>reflection.cpp</h1><a href="reflection_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 <span class="comment">/*</span>
<a name="l00003"></a>00003 <span class="comment">    pbrt source code Copyright(c) 1998-2007 Matt Pharr and Greg Humphreys.</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">    This file is part of pbrt.</span>
<a name="l00006"></a>00006 <span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment">    pbrt is free software; you can redistribute it and/or modify</span>
<a name="l00008"></a>00008 <span class="comment">    it under the terms of the GNU General Public License as published by</span>
<a name="l00009"></a>00009 <span class="comment">    the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00010"></a>00010 <span class="comment">    (at your option) any later version.  Note that the text contents of</span>
<a name="l00011"></a>00011 <span class="comment">    the book "Physically Based Rendering" are *not* licensed under the</span>
<a name="l00012"></a>00012 <span class="comment">    GNU GPL.</span>
<a name="l00013"></a>00013 <span class="comment"></span>
<a name="l00014"></a>00014 <span class="comment">    pbrt is distributed in the hope that it will be useful,</span>
<a name="l00015"></a>00015 <span class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00016"></a>00016 <span class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00017"></a>00017 <span class="comment">    GNU General Public License for more details.</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">    You should have received a copy of the GNU General Public License</span>
<a name="l00020"></a>00020 <span class="comment">    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00021"></a>00021 <span class="comment"></span>
<a name="l00022"></a>00022 <span class="comment"> */</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="comment">// reflection.cpp*</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include "<a class="code" href="reflection_8h.html">reflection.h</a>"</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="color_8h.html">color.h</a>"</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include "<a class="code" href="mc_8h.html">mc.h</a>"</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include "<a class="code" href="sampling_8h.html">sampling.h</a>"</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
<a name="l00030"></a>00030 <span class="comment">// BxDF Utility Functions</span>
<a name="l00031"></a><a class="code" href="reflection_8cpp.html#7643cb218ea071ca6e82084d20957c52">00031</a> <a class="code" href="pbrt_8h.html#1ca894daa11d476d9e76947dceaf0255">COREDLL</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="pbrt_8h.html#7643cb218ea071ca6e82084d20957c52">FrDiel</a>(<span class="keywordtype">float</span> cosi, <span class="keywordtype">float</span> cost,
<a name="l00032"></a>00032                         <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;etai,
<a name="l00033"></a>00033                                                 <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;etat) {
<a name="l00034"></a>00034         <a class="code" href="classSpectrum.html">Spectrum</a> Rparl = ((etat * cosi) - (etai * cost)) /
<a name="l00035"></a>00035                          ((etat * cosi) + (etai * cost));
<a name="l00036"></a>00036         <a class="code" href="classSpectrum.html">Spectrum</a> Rperp = ((etai * cosi) - (etat * cost)) /
<a name="l00037"></a>00037                          ((etai * cosi) + (etat * cost));
<a name="l00038"></a>00038         <span class="keywordflow">return</span> (Rparl*Rparl + Rperp*Rperp) / 2.f;
<a name="l00039"></a>00039 }
<a name="l00040"></a><a class="code" href="reflection_8cpp.html#8803724c062d84cd6f8e7ece474a650b">00040</a> <a class="code" href="pbrt_8h.html#1ca894daa11d476d9e76947dceaf0255">COREDLL</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="pbrt_8h.html#530c345512def4a99a7a8f600aeea045">FrCond</a>(<span class="keywordtype">float</span> cosi,
<a name="l00041"></a>00041                          <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;eta,
<a name="l00042"></a>00042                                              <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;k) {
<a name="l00043"></a>00043     <a class="code" href="classSpectrum.html">Spectrum</a> tmp = (eta*eta + k*k) * cosi*cosi;
<a name="l00044"></a>00044     <a class="code" href="classSpectrum.html">Spectrum</a> Rparl2 = (tmp - (2.f * eta * cosi) + 1) /
<a name="l00045"></a>00045         (tmp + (2.f * eta * cosi) + 1);
<a name="l00046"></a>00046     <a class="code" href="classSpectrum.html">Spectrum</a> tmp_f = eta*eta + k*k;
<a name="l00047"></a>00047     <a class="code" href="classSpectrum.html">Spectrum</a> Rperp2 =
<a name="l00048"></a>00048                 (tmp_f - (2.f * eta * cosi) + cosi*cosi) /
<a name="l00049"></a>00049             (tmp_f + (2.f * eta * cosi) + cosi*cosi);
<a name="l00050"></a>00050     <span class="keywordflow">return</span> (Rparl2 + Rperp2) / 2.f;
<a name="l00051"></a>00051 }
<a name="l00052"></a><a class="code" href="reflection_8cpp.html#35c4826ff9aa32ae8fe9162a0657c3af">00052</a> <a class="code" href="pbrt_8h.html#1ca894daa11d476d9e76947dceaf0255">COREDLL</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="pbrt_8h.html#17777aa1d14b118f9a14b54602dbe86e">FresnelApproxEta</a>(<span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;Fr) {
<a name="l00053"></a>00053         <a class="code" href="classSpectrum.html">Spectrum</a> reflectance = Fr.<a class="code" href="classSpectrum.html#e1a9c8547a9dd9ffd226bd227432c7ce">Clamp</a>(0.f, .999f);
<a name="l00054"></a>00054         <span class="keywordflow">return</span> (<a class="code" href="classSpectrum.html">Spectrum</a>(1.) + reflectance.<a class="code" href="classSpectrum.html#4f7d3964e95b5b2bd5581e32e71a2706">Sqrt</a>()) /
<a name="l00055"></a>00055                 (<a class="code" href="classSpectrum.html">Spectrum</a>(1.) - reflectance.<a class="code" href="classSpectrum.html#4f7d3964e95b5b2bd5581e32e71a2706">Sqrt</a>());
<a name="l00056"></a>00056 }
<a name="l00057"></a><a class="code" href="reflection_8cpp.html#ed297b4e7a528cf1e0660cb34b3ee9d8">00057</a> <a class="code" href="pbrt_8h.html#1ca894daa11d476d9e76947dceaf0255">COREDLL</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="pbrt_8h.html#ca1277586505f98d80b45ee2c5f913ea">FresnelApproxK</a>(<span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;Fr) {
<a name="l00058"></a>00058         <a class="code" href="classSpectrum.html">Spectrum</a> reflectance = Fr.<a class="code" href="classSpectrum.html#e1a9c8547a9dd9ffd226bd227432c7ce">Clamp</a>(0.f, .999f);
<a name="l00059"></a>00059         <span class="keywordflow">return</span> 2.f * (reflectance /
<a name="l00060"></a>00060                       (<a class="code" href="classSpectrum.html">Spectrum</a>(1.) - reflectance)).<a class="code" href="classSpectrum.html#4f7d3964e95b5b2bd5581e32e71a2706">Sqrt</a>();
<a name="l00061"></a>00061 }
<a name="l00062"></a>00062 <span class="comment">// BxDF Method Definitions</span>
<a name="l00063"></a><a class="code" href="classBRDFToBTDF.html#5c0edc880ac378674a0e93d2093649b2">00063</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBRDFToBTDF.html#5c0edc880ac378674a0e93d2093649b2">BRDFToBTDF::f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
<a name="l00064"></a>00064                        <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
<a name="l00065"></a>00065         <span class="keywordflow">return</span> <a class="code" href="classBRDFToBTDF.html#c3cbaf411293141f8357bdc896278dbb">brdf</a>-&gt;<a class="code" href="classBxDF.html#f1ca9885bff59445b7bab31e70e060af">f</a>(wo, <a class="code" href="classBRDFToBTDF.html#6e3aa5d9722e812c67459450261e2286">otherHemisphere</a>(wi));
<a name="l00066"></a>00066 }
<a name="l00067"></a><a class="code" href="classBRDFToBTDF.html#96bf369fff2c7a8db93e68755c8de0ef">00067</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBRDFToBTDF.html#96bf369fff2c7a8db93e68755c8de0ef">BRDFToBTDF::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="classVector.html">Vector</a> *wi,
<a name="l00068"></a>00068                 <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
<a name="l00069"></a>00069         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBRDFToBTDF.html#5c0edc880ac378674a0e93d2093649b2">f</a> = <a class="code" href="classBRDFToBTDF.html#c3cbaf411293141f8357bdc896278dbb">brdf</a>-&gt;<a class="code" href="classBxDF.html#34354c02d0f47926ebd477bddd2fcf0c">Sample_f</a>(wo, wi, u1, u2, pdf);
<a name="l00070"></a>00070         *wi = <a class="code" href="classBRDFToBTDF.html#6e3aa5d9722e812c67459450261e2286">otherHemisphere</a>(*wi);
<a name="l00071"></a>00071         <span class="keywordflow">return</span> f;
<a name="l00072"></a>00072 }
<a name="l00073"></a><a class="code" href="classFresnel.html#3796ca33fa2ddce0ab8cff0499008b1b">00073</a> <a class="code" href="classFresnel.html#3796ca33fa2ddce0ab8cff0499008b1b">Fresnel::~Fresnel</a>() { }
<a name="l00074"></a><a class="code" href="classFresnelConductor.html#58bf926bb86b12521dcc8efdda7ceca2">00074</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classFresnelConductor.html#58bf926bb86b12521dcc8efdda7ceca2">FresnelConductor::Evaluate</a>(<span class="keywordtype">float</span> cosi)<span class="keyword"> const </span>{
<a name="l00075"></a>00075         <span class="keywordflow">return</span> <a class="code" href="pbrt_8h.html#530c345512def4a99a7a8f600aeea045">FrCond</a>(fabsf(cosi), <a class="code" href="classFresnelConductor.html#ba9d36c10c98aa53d4308626102c4257">eta</a>, <a class="code" href="classFresnelConductor.html#8ba07fd76f5a1d94baf16a46756a4dac">k</a>);
<a name="l00076"></a>00076 }
<a name="l00077"></a><a class="code" href="classFresnelDielectric.html#c0b69c178a41ab73b77c1c8d19b8f71f">00077</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classFresnelDielectric.html#c0b69c178a41ab73b77c1c8d19b8f71f">FresnelDielectric::Evaluate</a>(<span class="keywordtype">float</span> cosi)<span class="keyword"> const </span>{
<a name="l00078"></a>00078         <span class="comment">// Compute Fresnel reflectance for dielectric</span>
<a name="l00079"></a>00079         cosi = <a class="code" href="pbrt_8h.html#036098e5cec04b73d8720de12e8e5cd1">Clamp</a>(cosi, -1.f, 1.f);
<a name="l00080"></a>00080         <span class="comment">// Compute indices of refraction for dielectric</span>
<a name="l00081"></a>00081         <span class="keywordtype">bool</span> entering = cosi &gt; 0.;
<a name="l00082"></a>00082         <span class="keywordtype">float</span> ei = <a class="code" href="classFresnelDielectric.html#66527db9cabc6b34a0988baab4bfe8ef">eta_i</a>, et = <a class="code" href="classFresnelDielectric.html#32ba657b6208dcf172f7d5394dedd7b3">eta_t</a>;
<a name="l00083"></a>00083         <span class="keywordflow">if</span> (!entering)
<a name="l00084"></a>00084                 swap(ei, et);
<a name="l00085"></a>00085         <span class="comment">// Compute _sint_ using Snell's law</span>
<a name="l00086"></a>00086         <span class="keywordtype">float</span> sint = ei/et * sqrtf(max(0.f, 1.f - cosi*cosi));
<a name="l00087"></a>00087         <span class="keywordflow">if</span> (sint &gt; 1.) {
<a name="l00088"></a>00088                 <span class="comment">// Handle total internal reflection</span>
<a name="l00089"></a>00089                 <span class="keywordflow">return</span> 1.;
<a name="l00090"></a>00090         }
<a name="l00091"></a>00091         <span class="keywordflow">else</span> {
<a name="l00092"></a>00092                 <span class="keywordtype">float</span> cost = sqrtf(max(0.f, 1.f - sint*sint));
<a name="l00093"></a>00093                 <span class="keywordflow">return</span> <a class="code" href="pbrt_8h.html#7643cb218ea071ca6e82084d20957c52">FrDiel</a>(fabsf(cosi), cost, ei, et);
<a name="l00094"></a>00094         }
<a name="l00095"></a>00095 }
<a name="l00096"></a><a class="code" href="classSpecularReflection.html#c1830f02b9b537e6bec2e14ef012c443">00096</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classSpecularReflection.html#c1830f02b9b537e6bec2e14ef012c443">SpecularReflection::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
<a name="l00097"></a>00097                 <a class="code" href="classVector.html">Vector</a> *wi, <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
<a name="l00098"></a>00098         <span class="comment">// Compute perfect specular reflection direction</span>
<a name="l00099"></a>00099         *wi = <a class="code" href="classVector.html">Vector</a>(-wo.<a class="code" href="classVector.html#ca49165049a1e21ae47afcfc078819ed">x</a>, -wo.<a class="code" href="classVector.html#81be9102fca6d9beea3efef522c4c09d">y</a>, wo.<a class="code" href="classVector.html#0e84237d0830d5c459bfa5676b5fbfba">z</a>);
<a name="l00100"></a>00100         *pdf = 1.f;
<a name="l00101"></a>00101         <span class="keywordflow">return</span> <a class="code" href="classSpecularReflection.html#f4beb127b8e3f61868d52edba0d18320">fresnel</a>-&gt;<a class="code" href="classFresnel.html#4ec50bd62f78000c8515974d6981b739">Evaluate</a>(<a class="code" href="reflection_8h.html#d7ed6c9d3491c7c0fb2070ac76dbd344">CosTheta</a>(wo)) * <a class="code" href="classSpecularReflection.html#7bc32c84f2d8ec593908694b57b552e7">R</a> /
<a name="l00102"></a>00102                 fabsf(<a class="code" href="reflection_8h.html#d7ed6c9d3491c7c0fb2070ac76dbd344">CosTheta</a>(*wi));
<a name="l00103"></a>00103 }
<a name="l00104"></a><a class="code" href="classSpecularTransmission.html#8ef8efbe35db827cf7e8901c5c5e4149">00104</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classSpecularTransmission.html#8ef8efbe35db827cf7e8901c5c5e4149">SpecularTransmission::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
<a name="l00105"></a>00105                 <a class="code" href="classVector.html">Vector</a> *wi, <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
<a name="l00106"></a>00106         <span class="comment">// Figure out which $\eta$ is incident and which is transmitted</span>
<a name="l00107"></a>00107         <span class="keywordtype">bool</span> entering = <a class="code" href="reflection_8h.html#d7ed6c9d3491c7c0fb2070ac76dbd344">CosTheta</a>(wo) &gt; 0.;
<a name="l00108"></a>00108         <span class="keywordtype">float</span> ei = <a class="code" href="classSpecularTransmission.html#d48c6379fb41a7d39ef0966bf48d97e4">etai</a>, et = <a class="code" href="classSpecularTransmission.html#1cfc0192a4e53b828ef3a1d8a372ef2d">etat</a>;
<a name="l00109"></a>00109         <span class="keywordflow">if</span> (!entering)
<a name="l00110"></a>00110                 swap(ei, et);
<a name="l00111"></a>00111         <span class="comment">// Compute transmitted ray direction</span>
<a name="l00112"></a>00112         <span class="keywordtype">float</span> sini2 = <a class="code" href="reflection_8h.html#0e141c9409a847f2e7207f826e311fac">SinTheta2</a>(wo);
<a name="l00113"></a>00113         <span class="keywordtype">float</span> eta = ei / et;
<a name="l00114"></a>00114         <span class="keywordtype">float</span> sint2 = eta * eta * sini2;
<a name="l00115"></a>00115         <span class="comment">// Handle total internal reflection for transmission</span>
<a name="l00116"></a>00116         <span class="keywordflow">if</span> (sint2 &gt; 1.) <span class="keywordflow">return</span> 0.;
<a name="l00117"></a>00117         <span class="keywordtype">float</span> cost = sqrtf(max(0.<a class="code" href="classSpecularTransmission.html#bae8e825a245322f215f8bff30c4b154">f</a>, 1.<a class="code" href="classSpecularTransmission.html#bae8e825a245322f215f8bff30c4b154">f</a> - sint2));
<a name="l00118"></a>00118         <span class="keywordflow">if</span> (entering) cost = -cost;
<a name="l00119"></a>00119         <span class="keywordtype">float</span> sintOverSini = eta;
<a name="l00120"></a>00120         *wi = <a class="code" href="classVector.html">Vector</a>(sintOverSini * -wo.<a class="code" href="classVector.html#ca49165049a1e21ae47afcfc078819ed">x</a>,
<a name="l00121"></a>00121                      sintOverSini * -wo.<a class="code" href="classVector.html#81be9102fca6d9beea3efef522c4c09d">y</a>,
<a name="l00122"></a>00122                                  cost);
<a name="l00123"></a>00123         *pdf = 1.f;
<a name="l00124"></a>00124         <a class="code" href="classSpectrum.html">Spectrum</a> F = <a class="code" href="classSpecularTransmission.html#c67fa81eaf2b47789f7fd942510f4b2b">fresnel</a>.<a class="code" href="classFresnelDielectric.html#c0b69c178a41ab73b77c1c8d19b8f71f">Evaluate</a>(<a class="code" href="reflection_8h.html#d7ed6c9d3491c7c0fb2070ac76dbd344">CosTheta</a>(wo));
<a name="l00125"></a>00125         <span class="keywordflow">return</span> (et*et)/(ei*ei) * (<a class="code" href="classSpectrum.html">Spectrum</a>(1.)-F) * <a class="code" href="classSpecularTransmission.html#0bbfee38353896f12a1d6ee89ed23846">T</a> /
<a name="l00126"></a>00126                 fabsf(<a class="code" href="reflection_8h.html#d7ed6c9d3491c7c0fb2070ac76dbd344">CosTheta</a>(*wi));
<a name="l00127"></a>00127 }
<a name="l00128"></a><a class="code" href="classLambertian.html#fbd615e209032b677a5ad29dabaf7a0e">00128</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classLambertian.html#fbd615e209032b677a5ad29dabaf7a0e">Lambertian::f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
<a name="l00129"></a>00129                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
<a name="l00130"></a>00130         <span class="keywordflow">return</span> <a class="code" href="classLambertian.html#e711ef9a6d19ca2442de770a9c449d49">RoverPI</a>;
<a name="l00131"></a>00131 }
<a name="l00132"></a><a class="code" href="classOrenNayar.html#a452c177f671c5d5ee8108b9bbe6c2a8">00132</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classOrenNayar.html#a452c177f671c5d5ee8108b9bbe6c2a8">OrenNayar::f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
<a name="l00133"></a>00133                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
<a name="l00134"></a>00134         <span class="keywordtype">float</span> sinthetai = <a class="code" href="reflection_8h.html#47faf56c4289b6a46012feed69fc2c44">SinTheta</a>(wi);
<a name="l00135"></a>00135         <span class="keywordtype">float</span> sinthetao = <a class="code" href="reflection_8h.html#47faf56c4289b6a46012feed69fc2c44">SinTheta</a>(wo);
<a name="l00136"></a>00136         <span class="comment">// Compute cosine term of Oren--Nayar model</span>
<a name="l00137"></a>00137         <span class="keywordtype">float</span> maxcos = 0.f;
<a name="l00138"></a>00138         <span class="keywordflow">if</span> (sinthetai &gt; 1e-4 &amp;&amp; sinthetao &gt; 1e-4) {
<a name="l00139"></a>00139                 <span class="keywordtype">float</span> sinphii = <a class="code" href="reflection_8h.html#b2236908583b4be28270667fadb3180c">SinPhi</a>(wi), cosphii = <a class="code" href="reflection_8h.html#c047bd30fe4ce0d16b8df138b42ddd85">CosPhi</a>(wi);
<a name="l00140"></a>00140                 <span class="keywordtype">float</span> sinphio = <a class="code" href="reflection_8h.html#b2236908583b4be28270667fadb3180c">SinPhi</a>(wo), cosphio = <a class="code" href="reflection_8h.html#c047bd30fe4ce0d16b8df138b42ddd85">CosPhi</a>(wo);
<a name="l00141"></a>00141                 <span class="keywordtype">float</span> dcos = cosphii * cosphio + sinphii * sinphio;
<a name="l00142"></a>00142                 maxcos = max(0.<a class="code" href="classOrenNayar.html#a452c177f671c5d5ee8108b9bbe6c2a8">f</a>, dcos);
<a name="l00143"></a>00143         }
<a name="l00144"></a>00144         <span class="comment">// Compute sine and tangent terms of Oren--Nayar model</span>
<a name="l00145"></a>00145         <span class="keywordtype">float</span> sinalpha, tanbeta;
<a name="l00146"></a>00146         <span class="keywordflow">if</span> (fabsf(<a class="code" href="reflection_8h.html#d7ed6c9d3491c7c0fb2070ac76dbd344">CosTheta</a>(wi)) &gt; fabsf(<a class="code" href="reflection_8h.html#d7ed6c9d3491c7c0fb2070ac76dbd344">CosTheta</a>(wo))) {
<a name="l00147"></a>00147                 sinalpha = sinthetao;
<a name="l00148"></a>00148                 tanbeta = sinthetai / fabsf(<a class="code" href="reflection_8h.html#d7ed6c9d3491c7c0fb2070ac76dbd344">CosTheta</a>(wi));
<a name="l00149"></a>00149         }
<a name="l00150"></a>00150         <span class="keywordflow">else</span> {
<a name="l00151"></a>00151                 sinalpha = sinthetai;
<a name="l00152"></a>00152                 tanbeta = sinthetao / fabsf(<a class="code" href="reflection_8h.html#d7ed6c9d3491c7c0fb2070ac76dbd344">CosTheta</a>(wo));
<a name="l00153"></a>00153         }
<a name="l00154"></a>00154         <span class="keywordflow">return</span> <a class="code" href="classOrenNayar.html#8fd6ee81da1700e080ffe68fe52f018d">R</a> * <a class="code" href="pbrt_8h.html#ebad45bfa06a5d66805c5813fbc59f4b">INV_PI</a> *
<a name="l00155"></a>00155                (<a class="code" href="classOrenNayar.html#a480828a2e8a4cfe65c346cf7fec8ca5">A</a> + <a class="code" href="classOrenNayar.html#9001ec4646b241bb54fb333f21aa722e">B</a> * maxcos * sinalpha * tanbeta);
<a name="l00156"></a>00156 }
<a name="l00157"></a><a class="code" href="classMicrofacet.html#d69b0f7aa2b02aa438d6389468c56655">00157</a> <a class="code" href="classMicrofacet.html#d69b0f7aa2b02aa438d6389468c56655">Microfacet::Microfacet</a>(<span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;reflectance,
<a name="l00158"></a>00158                        <a class="code" href="classFresnel.html">Fresnel</a> *<a class="code" href="classOrenNayar.html#a452c177f671c5d5ee8108b9bbe6c2a8">f</a>,
<a name="l00159"></a>00159                                            <a class="code" href="classMicrofacetDistribution.html">MicrofacetDistribution</a> *d)
<a name="l00160"></a>00160         : <a class="code" href="classBxDF.html">BxDF</a>(<a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730">BxDFType</a>(<a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e6697304331da0ab7ddceadcfffa81ecf70577e">BSDF_REFLECTION</a> | <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e6697308ddc5e83718e553544ef1f3b0aa1329b">BSDF_GLOSSY</a>)),
<a name="l00161"></a>00161          <a class="code" href="classOrenNayar.html#8fd6ee81da1700e080ffe68fe52f018d">R</a>(reflectance), distribution(d), fresnel(f) {
<a name="l00162"></a>00162 }
<a name="l00163"></a><a class="code" href="classMicrofacet.html#2027302e15bf85f739a4bd709fc72fe7">00163</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classMicrofacet.html#2027302e15bf85f739a4bd709fc72fe7">Microfacet::f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
<a name="l00164"></a>00164                        <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
<a name="l00165"></a>00165         <span class="keywordtype">float</span> cosThetaO = fabsf(<a class="code" href="reflection_8h.html#d7ed6c9d3491c7c0fb2070ac76dbd344">CosTheta</a>(wo));
<a name="l00166"></a>00166         <span class="keywordtype">float</span> cosThetaI = fabsf(<a class="code" href="reflection_8h.html#d7ed6c9d3491c7c0fb2070ac76dbd344">CosTheta</a>(wi));
<a name="l00167"></a>00167         <a class="code" href="classVector.html">Vector</a> wh = <a class="code" href="geometry_8h.html#46448bfa3df1c2de5e3b763f163866a4">Normalize</a>(wi + wo);
<a name="l00168"></a>00168         <span class="keywordtype">float</span> cosThetaH = <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(wi, wh);
<a name="l00169"></a>00169         <a class="code" href="classSpectrum.html">Spectrum</a> F = <a class="code" href="classMicrofacet.html#fd28e6942d9817bac4c714869a64db93">fresnel</a>-&gt;<a class="code" href="classFresnel.html#4ec50bd62f78000c8515974d6981b739">Evaluate</a>(cosThetaH);
<a name="l00170"></a>00170         <span class="keywordflow">return</span> <a class="code" href="classMicrofacet.html#ff5c5647c83ccd458cbdca8eb744ad9f">R</a> * <a class="code" href="classMicrofacet.html#d30351dc75b23ac9d1da06da5de6cfd9">distribution</a>-&gt;<a class="code" href="classMicrofacetDistribution.html#332f586d59a2519c7890b95d64b0ed8a">D</a>(wh) * <a class="code" href="classMicrofacet.html#be1def78cd3f9b1cff561ff6e8b9ddb3">G</a>(wo, wi, wh) * F /
<a name="l00171"></a>00171                  (4.f * cosThetaI * cosThetaO);
<a name="l00172"></a>00172 }
<a name="l00173"></a><a class="code" href="classLafortune.html#dc889396e8e0b29e621b04d99dcb84d1">00173</a> <a class="code" href="classLafortune.html#dc889396e8e0b29e621b04d99dcb84d1">Lafortune::Lafortune</a>(<span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;r, <a class="code" href="pbrt_8h.html#c319c165d52643e43249fe003e18bdf3">u_int</a> nl,
<a name="l00174"></a>00174         <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> *xx,
<a name="l00175"></a>00175         <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> *yy,
<a name="l00176"></a>00176         <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> *zz,
<a name="l00177"></a>00177         <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> *e, <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730">BxDFType</a> t)
<a name="l00178"></a>00178         : <a class="code" href="classBxDF.html">BxDF</a>(t), <a class="code" href="classMicrofacet.html#ff5c5647c83ccd458cbdca8eb744ad9f">R</a>(r) {
<a name="l00179"></a>00179         <a class="code" href="classLafortune.html#883291c1c3139ea14b69c4e812b23c18">nLobes</a> = nl;
<a name="l00180"></a>00180         <a class="code" href="classLafortune.html#ce203e215ee8ab3f9019da2d4008c8bc">x</a> = xx;
<a name="l00181"></a>00181         <a class="code" href="classLafortune.html#341c13946da342ffdf9047379c9215c3">y</a> = yy;
<a name="l00182"></a>00182         <a class="code" href="classLafortune.html#7257faa037d20db671fcc02dee2186fd">z</a> = zz;
<a name="l00183"></a>00183         <a class="code" href="classLafortune.html#6fc8e80e49458e028fac30a3b4d97583">exponent</a> = e;
<a name="l00184"></a>00184 }
<a name="l00185"></a><a class="code" href="classLafortune.html#cc41c927cd5329c7254d4d786f20d1d2">00185</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classLafortune.html#cc41c927cd5329c7254d4d786f20d1d2">Lafortune::f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
<a name="l00186"></a>00186                       <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
<a name="l00187"></a>00187         <a class="code" href="classSpectrum.html">Spectrum</a> ret = <a class="code" href="classLafortune.html#c54eb5eda6460497c5edf967b6bf1fb2">R</a> * <a class="code" href="pbrt_8h.html#ebad45bfa06a5d66805c5813fbc59f4b">INV_PI</a>;
<a name="l00188"></a>00188         <span class="keywordflow">for</span> (<a class="code" href="pbrt_8h.html#c319c165d52643e43249fe003e18bdf3">u_int</a> i = 0; i &lt; <a class="code" href="classLafortune.html#883291c1c3139ea14b69c4e812b23c18">nLobes</a>; ++i) {
<a name="l00189"></a>00189                 <span class="comment">// Add contribution for $i$th Phong lobe</span>
<a name="l00190"></a>00190                 <a class="code" href="classSpectrum.html">Spectrum</a> v = <a class="code" href="classLafortune.html#ce203e215ee8ab3f9019da2d4008c8bc">x</a>[i] * wo.<a class="code" href="classVector.html#ca49165049a1e21ae47afcfc078819ed">x</a> * wi.<a class="code" href="classVector.html#ca49165049a1e21ae47afcfc078819ed">x</a> + <a class="code" href="classLafortune.html#341c13946da342ffdf9047379c9215c3">y</a>[i] * wo.<a class="code" href="classVector.html#81be9102fca6d9beea3efef522c4c09d">y</a> * wi.<a class="code" href="classVector.html#81be9102fca6d9beea3efef522c4c09d">y</a> +
<a name="l00191"></a>00191                         <a class="code" href="classLafortune.html#7257faa037d20db671fcc02dee2186fd">z</a>[i] * wo.<a class="code" href="classVector.html#0e84237d0830d5c459bfa5676b5fbfba">z</a> * wi.<a class="code" href="classVector.html#0e84237d0830d5c459bfa5676b5fbfba">z</a>;
<a name="l00192"></a>00192                 ret += v.<a class="code" href="classSpectrum.html#bc6e5d1035045cb32a177e2d4ab54ce4">Pow</a>(<a class="code" href="classLafortune.html#6fc8e80e49458e028fac30a3b4d97583">exponent</a>[i]);
<a name="l00193"></a>00193         }
<a name="l00194"></a>00194         <span class="keywordflow">return</span> ret;
<a name="l00195"></a>00195 }
<a name="l00196"></a><a class="code" href="classFresnelBlend.html#eb2463be6c5523c6ba144d593dc0c73f">00196</a> <a class="code" href="classFresnelBlend.html#eb2463be6c5523c6ba144d593dc0c73f">FresnelBlend::FresnelBlend</a>(<span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;d,
<a name="l00197"></a>00197                            <span class="keyword">const</span> <a class="code" href="classSpectrum.html">Spectrum</a> &amp;s,
<a name="l00198"></a>00198                                                    <a class="code" href="classMicrofacetDistribution.html">MicrofacetDistribution</a> *dist)
<a name="l00199"></a>00199         : <a class="code" href="classBxDF.html">BxDF</a>(<a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730">BxDFType</a>(<a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e6697304331da0ab7ddceadcfffa81ecf70577e">BSDF_REFLECTION</a> | <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e6697308ddc5e83718e553544ef1f3b0aa1329b">BSDF_GLOSSY</a>)),
<a name="l00200"></a>00200           Rd(d), Rs(s) {
<a name="l00201"></a>00201         <a class="code" href="classFresnelBlend.html#2673c0a36ffad7fcf763ee58869f97f3">distribution</a> = dist;
<a name="l00202"></a>00202 }
<a name="l00203"></a><a class="code" href="classFresnelBlend.html#59104752a3144c9be628a433c3f1ef66">00203</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classFresnelBlend.html#59104752a3144c9be628a433c3f1ef66">FresnelBlend::f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
<a name="l00204"></a>00204                          <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
<a name="l00205"></a>00205         <a class="code" href="classSpectrum.html">Spectrum</a> diffuse = (28.f/(23.f*<a class="code" href="pbrt_8h.html#e71449b1cc6e6250b91f539153a7a0d3">M_PI</a>)) * <a class="code" href="classFresnelBlend.html#8b2322952823148d11adfdbea5b21952">Rd</a> *
<a name="l00206"></a>00206                 (<a class="code" href="classSpectrum.html">Spectrum</a>(1.) - <a class="code" href="classFresnelBlend.html#8f88496933dda3d2ca163add6a875766">Rs</a>) *
<a name="l00207"></a>00207                 (1 - powf(1 - .5<a class="code" href="classFresnelBlend.html#59104752a3144c9be628a433c3f1ef66">f</a> * fabsf(<a class="code" href="reflection_8h.html#d7ed6c9d3491c7c0fb2070ac76dbd344">CosTheta</a>(wi)), 5)) *
<a name="l00208"></a>00208                 (1 - powf(1 - .5<a class="code" href="classFresnelBlend.html#59104752a3144c9be628a433c3f1ef66">f</a> * fabsf(<a class="code" href="reflection_8h.html#d7ed6c9d3491c7c0fb2070ac76dbd344">CosTheta</a>(wo)), 5));
<a name="l00209"></a>00209         <a class="code" href="classVector.html">Vector</a> H = <a class="code" href="geometry_8h.html#46448bfa3df1c2de5e3b763f163866a4">Normalize</a>(wi + wo);
<a name="l00210"></a>00210         <a class="code" href="classSpectrum.html">Spectrum</a> specular = <a class="code" href="classFresnelBlend.html#2673c0a36ffad7fcf763ee58869f97f3">distribution</a>-&gt;<a class="code" href="classMicrofacetDistribution.html#332f586d59a2519c7890b95d64b0ed8a">D</a>(H) /
<a name="l00211"></a>00211                 (4.f * <a class="code" href="geometry_8h.html#0c07ebf9b1454b90d6646a2f89065bb3">AbsDot</a>(wi, H) *
<a name="l00212"></a>00212                 max(fabsf(<a class="code" href="reflection_8h.html#d7ed6c9d3491c7c0fb2070ac76dbd344">CosTheta</a>(wi)), fabsf(<a class="code" href="reflection_8h.html#d7ed6c9d3491c7c0fb2070ac76dbd344">CosTheta</a>(wo)))) *
<a name="l00213"></a>00213                 <a class="code" href="classFresnelBlend.html#a1fedf51b768c11b1da5e769db1dedaf">SchlickFresnel</a>(<a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(wi, H));
<a name="l00214"></a>00214         <span class="keywordflow">return</span> diffuse + specular;
<a name="l00215"></a>00215 }
<a name="l00216"></a><a class="code" href="classBxDF.html#34354c02d0f47926ebd477bddd2fcf0c">00216</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBxDF.html#34354c02d0f47926ebd477bddd2fcf0c">BxDF::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="classVector.html">Vector</a> *wi,
<a name="l00217"></a>00217                 <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
<a name="l00218"></a>00218         <span class="comment">// Cosine-sample the hemisphere, flipping the direction if necessary</span>
<a name="l00219"></a>00219         *wi = <a class="code" href="mc_8h.html#54b59b556ffadb99f2f8358689b1357d">CosineSampleHemisphere</a>(u1, u2);
<a name="l00220"></a>00220         <span class="keywordflow">if</span> (wo.<a class="code" href="classVector.html#0e84237d0830d5c459bfa5676b5fbfba">z</a> &lt; 0.) wi-&gt;<a class="code" href="classVector.html#0e84237d0830d5c459bfa5676b5fbfba">z</a> *= -1.f;
<a name="l00221"></a>00221         *pdf = <a class="code" href="classBxDF.html#c0f2ffe7dfa375ccb8d03519a39e33e6">Pdf</a>(wo, *wi);
<a name="l00222"></a>00222         <span class="keywordflow">return</span> <a class="code" href="classBxDF.html#f1ca9885bff59445b7bab31e70e060af">f</a>(wo, *wi);
<a name="l00223"></a>00223 }
<a name="l00224"></a><a class="code" href="classBxDF.html#c0f2ffe7dfa375ccb8d03519a39e33e6">00224</a> <span class="keywordtype">float</span> <a class="code" href="classBxDF.html#c0f2ffe7dfa375ccb8d03519a39e33e6">BxDF::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
<a name="l00225"></a>00225         <span class="keywordflow">return</span>
<a name="l00226"></a>00226                 <a class="code" href="reflection_8h.html#ebb77387f6dcac75991e45a8bed10ee8">SameHemisphere</a>(wo, wi) ? fabsf(wi.<a class="code" href="classVector.html#0e84237d0830d5c459bfa5676b5fbfba">z</a>) * <a class="code" href="pbrt_8h.html#ebad45bfa06a5d66805c5813fbc59f4b">INV_PI</a> : 0.f;
<a name="l00227"></a>00227 }
<a name="l00228"></a><a class="code" href="classBRDFToBTDF.html#1e789bb6958fd095d5e5c71758b4ad6b">00228</a> <span class="keywordtype">float</span> <a class="code" href="classBRDFToBTDF.html#1e789bb6958fd095d5e5c71758b4ad6b">BRDFToBTDF::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
<a name="l00229"></a>00229                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
<a name="l00230"></a>00230         <span class="keywordflow">return</span> <a class="code" href="classBRDFToBTDF.html#c3cbaf411293141f8357bdc896278dbb">brdf</a>-&gt;<a class="code" href="classBxDF.html#c0f2ffe7dfa375ccb8d03519a39e33e6">Pdf</a>(wo, -wi);
<a name="l00231"></a>00231 }
<a name="l00232"></a><a class="code" href="classMicrofacet.html#896f3d5d9e6839e9196317e025f2d546">00232</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classMicrofacet.html#896f3d5d9e6839e9196317e025f2d546">Microfacet::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="classVector.html">Vector</a> *wi,
<a name="l00233"></a>00233                 <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
<a name="l00234"></a>00234         <a class="code" href="classMicrofacet.html#d30351dc75b23ac9d1da06da5de6cfd9">distribution</a>-&gt;<a class="code" href="classMicrofacetDistribution.html#366ee22cdddc25b95ec20b62f5ea8f10">Sample_f</a>(wo, wi, u1, u2, pdf);
<a name="l00235"></a>00235         <span class="keywordflow">if</span> (!<a class="code" href="reflection_8h.html#ebb77387f6dcac75991e45a8bed10ee8">SameHemisphere</a>(wo, *wi)) <span class="keywordflow">return</span> <a class="code" href="classSpectrum.html">Spectrum</a>(0.<a class="code" href="classMicrofacet.html#2027302e15bf85f739a4bd709fc72fe7">f</a>);
<a name="l00236"></a>00236         <span class="keywordflow">return</span> <a class="code" href="classMicrofacet.html#2027302e15bf85f739a4bd709fc72fe7">f</a>(wo, *wi);
<a name="l00237"></a>00237 }
<a name="l00238"></a><a class="code" href="classMicrofacet.html#8e6987a7a1bb06868008b8096218e42a">00238</a> <span class="keywordtype">float</span> <a class="code" href="classMicrofacet.html#8e6987a7a1bb06868008b8096218e42a">Microfacet::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
<a name="l00239"></a>00239                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
<a name="l00240"></a>00240         <span class="keywordflow">if</span> (!<a class="code" href="reflection_8h.html#ebb77387f6dcac75991e45a8bed10ee8">SameHemisphere</a>(wo, wi)) <span class="keywordflow">return</span> 0.f;
<a name="l00241"></a>00241         <span class="keywordflow">return</span> <a class="code" href="classMicrofacet.html#d30351dc75b23ac9d1da06da5de6cfd9">distribution</a>-&gt;<a class="code" href="classMicrofacetDistribution.html#7bbd3ac3e59d5efdcfda9a5f69bcc15b">Pdf</a>(wo, wi);
<a name="l00242"></a>00242 }
<a name="l00243"></a><a class="code" href="classBlinn.html#14cfdf6721c621730d8dd0de7ed27ff8">00243</a> <span class="keywordtype">void</span> <a class="code" href="classBlinn.html#14cfdf6721c621730d8dd0de7ed27ff8">Blinn::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="classVector.html">Vector</a> *wi,
<a name="l00244"></a>00244                 <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
<a name="l00245"></a>00245         <span class="comment">// Compute sampled half-angle vector $\wh$ for Blinn distribution</span>
<a name="l00246"></a>00246         <span class="keywordtype">float</span> costheta = powf(u1, 1.f / (<a class="code" href="classBlinn.html#83d62ef7857ef371fe52cd18a210445e">exponent</a>+1));
<a name="l00247"></a>00247         <span class="keywordtype">float</span> sintheta = sqrtf(max(0.f, 1.f - costheta*costheta));
<a name="l00248"></a>00248         <span class="keywordtype">float</span> phi = u2 * 2.f * <a class="code" href="pbrt_8h.html#e71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l00249"></a>00249         <a class="code" href="classVector.html">Vector</a> H = <a class="code" href="geometry_8h.html#0d09426bc3aa2ca26c053e5efc1bfce5">SphericalDirection</a>(sintheta, costheta, phi);
<a name="l00250"></a>00250         <span class="keywordflow">if</span> (!<a class="code" href="reflection_8h.html#ebb77387f6dcac75991e45a8bed10ee8">SameHemisphere</a>(wo, H)) H.<a class="code" href="classVector.html#0e84237d0830d5c459bfa5676b5fbfba">z</a> *= -1.f;
<a name="l00251"></a>00251         <span class="comment">// Compute incident direction by reflecting about $\wh$</span>
<a name="l00252"></a>00252         *wi = -wo + 2.f * <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(wo, H) * H;
<a name="l00253"></a>00253         <span class="comment">// Compute PDF for \wi from Blinn distribution</span>
<a name="l00254"></a>00254         <span class="keywordtype">float</span> blinn_pdf = ((<a class="code" href="classBlinn.html#83d62ef7857ef371fe52cd18a210445e">exponent</a> + 2.f) *
<a name="l00255"></a>00255                            powf(costheta, <a class="code" href="classBlinn.html#83d62ef7857ef371fe52cd18a210445e">exponent</a>)) /
<a name="l00256"></a>00256                 (2.f * <a class="code" href="pbrt_8h.html#e71449b1cc6e6250b91f539153a7a0d3">M_PI</a> * 4.f * <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(wo, H));
<a name="l00257"></a>00257         *pdf = blinn_pdf;
<a name="l00258"></a>00258 }
<a name="l00259"></a><a class="code" href="classBlinn.html#9c20e1839ce146c37abc65ca5f8f682a">00259</a> <span class="keywordtype">float</span> <a class="code" href="classBlinn.html#9c20e1839ce146c37abc65ca5f8f682a">Blinn::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
<a name="l00260"></a>00260         <a class="code" href="classVector.html">Vector</a> H = <a class="code" href="geometry_8h.html#46448bfa3df1c2de5e3b763f163866a4">Normalize</a>(wo + wi);
<a name="l00261"></a>00261         <span class="keywordtype">float</span> costheta = fabsf(H.<a class="code" href="classVector.html#0e84237d0830d5c459bfa5676b5fbfba">z</a>);
<a name="l00262"></a>00262         <span class="comment">// Compute PDF for \wi from Blinn distribution</span>
<a name="l00263"></a>00263         <span class="keywordtype">float</span> blinn_pdf = ((<a class="code" href="classBlinn.html#83d62ef7857ef371fe52cd18a210445e">exponent</a> + 2.f) *
<a name="l00264"></a>00264                            powf(costheta, <a class="code" href="classBlinn.html#83d62ef7857ef371fe52cd18a210445e">exponent</a>)) /
<a name="l00265"></a>00265                 (2.f * <a class="code" href="pbrt_8h.html#e71449b1cc6e6250b91f539153a7a0d3">M_PI</a> * 4.f * <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(wo, H));
<a name="l00266"></a>00266         <span class="keywordflow">return</span> blinn_pdf;
<a name="l00267"></a>00267 }
<a name="l00268"></a><a class="code" href="classAnisotropic.html#70c18f6be79983ae5b6943206569f4df">00268</a> <span class="keywordtype">void</span> <a class="code" href="classAnisotropic.html#70c18f6be79983ae5b6943206569f4df">Anisotropic::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="classVector.html">Vector</a> *wi,
<a name="l00269"></a>00269                 <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
<a name="l00270"></a>00270         <span class="comment">// Sample from first quadrant and remap to hemisphere to sample \wh</span>
<a name="l00271"></a>00271         <span class="keywordtype">float</span> phi, costheta;
<a name="l00272"></a>00272         <span class="keywordflow">if</span> (u1 &lt; .25f) {
<a name="l00273"></a>00273                 <a class="code" href="classAnisotropic.html#a5aeee9bc6db928825ddee2c3c4d222e">sampleFirstQuadrant</a>(4.f * u1, u2, &amp;phi, &amp;costheta);
<a name="l00274"></a>00274         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u1 &lt; .5f) {
<a name="l00275"></a>00275                 u1 = 4.f * (.5f - u1);
<a name="l00276"></a>00276                 <a class="code" href="classAnisotropic.html#a5aeee9bc6db928825ddee2c3c4d222e">sampleFirstQuadrant</a>(u1, u2, &amp;phi, &amp;costheta);
<a name="l00277"></a>00277                 phi = <a class="code" href="pbrt_8h.html#e71449b1cc6e6250b91f539153a7a0d3">M_PI</a> - phi;
<a name="l00278"></a>00278         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u1 &lt; .75f) {
<a name="l00279"></a>00279                 u1 = 4.f * (u1 - .5f);
<a name="l00280"></a>00280                 <a class="code" href="classAnisotropic.html#a5aeee9bc6db928825ddee2c3c4d222e">sampleFirstQuadrant</a>(u1, u2, &amp;phi, &amp;costheta);
<a name="l00281"></a>00281                 phi += <a class="code" href="pbrt_8h.html#e71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l00282"></a>00282         } <span class="keywordflow">else</span> {
<a name="l00283"></a>00283                 u1 = 4.f * (1.f - u1);
<a name="l00284"></a>00284                 <a class="code" href="classAnisotropic.html#a5aeee9bc6db928825ddee2c3c4d222e">sampleFirstQuadrant</a>(u1, u2, &amp;phi, &amp;costheta);
<a name="l00285"></a>00285                 phi = 2.f * <a class="code" href="pbrt_8h.html#e71449b1cc6e6250b91f539153a7a0d3">M_PI</a> - phi;
<a name="l00286"></a>00286         }
<a name="l00287"></a>00287         <span class="keywordtype">float</span> sintheta = sqrtf(max(0.f, 1.f - costheta*costheta));
<a name="l00288"></a>00288         <a class="code" href="classVector.html">Vector</a> H = <a class="code" href="geometry_8h.html#0d09426bc3aa2ca26c053e5efc1bfce5">SphericalDirection</a>(sintheta, costheta, phi);
<a name="l00289"></a>00289         <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(wo, H) &lt; 0.f) H = -H;
<a name="l00290"></a>00290         <span class="comment">// Compute incident direction by reflecting about $\wh$</span>
<a name="l00291"></a>00291         *wi = -wo + 2.f * <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(wo, H) * H;
<a name="l00292"></a>00292         <span class="comment">// Compute PDF for \wi from Anisotropic distribution</span>
<a name="l00293"></a>00293         <span class="keywordtype">float</span> anisotropic_pdf = <a class="code" href="classAnisotropic.html#be0d20d7f7045cf107705f922477b49a">D</a>(H) / (4.f * <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(wo, H));
<a name="l00294"></a>00294         <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(wo, H) &lt; 0.f) anisotropic_pdf = 0.f;
<a name="l00295"></a>00295         *pdf = anisotropic_pdf;
<a name="l00296"></a>00296 }
<a name="l00297"></a><a class="code" href="classAnisotropic.html#a5aeee9bc6db928825ddee2c3c4d222e">00297</a> <span class="keywordtype">void</span> <a class="code" href="classAnisotropic.html#a5aeee9bc6db928825ddee2c3c4d222e">Anisotropic::sampleFirstQuadrant</a>(<span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2,
<a name="l00298"></a>00298                 <span class="keywordtype">float</span> *phi, <span class="keywordtype">float</span> *costheta)<span class="keyword"> const </span>{
<a name="l00299"></a>00299         <span class="keywordflow">if</span> (<a class="code" href="classAnisotropic.html#4e120ba92ebbd200c6c53e0a5639ac83">ex</a> == <a class="code" href="classAnisotropic.html#8505713e101722785f2f5b3d9455afde">ey</a>)
<a name="l00300"></a>00300                 *phi = <a class="code" href="pbrt_8h.html#e71449b1cc6e6250b91f539153a7a0d3">M_PI</a> * u1 * 0.5f;
<a name="l00301"></a>00301         <span class="keywordflow">else</span>
<a name="l00302"></a>00302                 *phi = atanf(sqrtf((<a class="code" href="classAnisotropic.html#4e120ba92ebbd200c6c53e0a5639ac83">ex</a>+1)/(<a class="code" href="classAnisotropic.html#8505713e101722785f2f5b3d9455afde">ey</a>+1)) *
<a name="l00303"></a>00303                         tanf(<a class="code" href="pbrt_8h.html#e71449b1cc6e6250b91f539153a7a0d3">M_PI</a> * u1 * 0.5f));
<a name="l00304"></a>00304         <span class="keywordtype">float</span> cosphi = cosf(*phi), sinphi = sinf(*phi);
<a name="l00305"></a>00305         *costheta = powf(u2, 1.f/(<a class="code" href="classAnisotropic.html#4e120ba92ebbd200c6c53e0a5639ac83">ex</a> * cosphi * cosphi +
<a name="l00306"></a>00306                 <a class="code" href="classAnisotropic.html#8505713e101722785f2f5b3d9455afde">ey</a> * sinphi * sinphi + 1));
<a name="l00307"></a>00307 }
<a name="l00308"></a><a class="code" href="classAnisotropic.html#78b71aad64cdbf7bd25f2e5528c7211f">00308</a> <span class="keywordtype">float</span> <a class="code" href="classAnisotropic.html#78b71aad64cdbf7bd25f2e5528c7211f">Anisotropic::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
<a name="l00309"></a>00309                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
<a name="l00310"></a>00310         <a class="code" href="classVector.html">Vector</a> H = <a class="code" href="geometry_8h.html#46448bfa3df1c2de5e3b763f163866a4">Normalize</a>(wo + wi);
<a name="l00311"></a>00311         <span class="comment">// Compute PDF for \wi from Anisotropic distribution</span>
<a name="l00312"></a>00312         <span class="keywordtype">float</span> anisotropic_pdf = <a class="code" href="classAnisotropic.html#be0d20d7f7045cf107705f922477b49a">D</a>(H) / (4.f * <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(wo, H));
<a name="l00313"></a>00313         <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(wo, H) &lt; 0.f) anisotropic_pdf = 0.f;
<a name="l00314"></a>00314         <span class="keywordflow">return</span> anisotropic_pdf;
<a name="l00315"></a>00315 }
<a name="l00316"></a><a class="code" href="classFresnelBlend.html#755dc375272b6a826fbfb65658e77f68">00316</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classFresnelBlend.html#755dc375272b6a826fbfb65658e77f68">FresnelBlend::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
<a name="l00317"></a>00317                 <a class="code" href="classVector.html">Vector</a> *wi, <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> *pdf)<span class="keyword"> const </span>{
<a name="l00318"></a>00318         <span class="keywordflow">if</span> (u1 &lt; .5) {
<a name="l00319"></a>00319                 u1 = 2.f * u1;
<a name="l00320"></a>00320                 <span class="comment">// Cosine-sample the hemisphere, flipping the direction if necessary</span>
<a name="l00321"></a>00321                 *wi = <a class="code" href="mc_8h.html#54b59b556ffadb99f2f8358689b1357d">CosineSampleHemisphere</a>(u1, u2);
<a name="l00322"></a>00322                 <span class="keywordflow">if</span> (wo.<a class="code" href="classVector.html#0e84237d0830d5c459bfa5676b5fbfba">z</a> &lt; 0.) wi-&gt;<a class="code" href="classVector.html#0e84237d0830d5c459bfa5676b5fbfba">z</a> *= -1.f;
<a name="l00323"></a>00323         }
<a name="l00324"></a>00324         <span class="keywordflow">else</span> {
<a name="l00325"></a>00325                 u1 = 2.f * (u1 - .5f);
<a name="l00326"></a>00326                 <a class="code" href="classFresnelBlend.html#2673c0a36ffad7fcf763ee58869f97f3">distribution</a>-&gt;<a class="code" href="classMicrofacetDistribution.html#366ee22cdddc25b95ec20b62f5ea8f10">Sample_f</a>(wo, wi, u1, u2, pdf);
<a name="l00327"></a>00327                 <span class="keywordflow">if</span> (!<a class="code" href="reflection_8h.html#ebb77387f6dcac75991e45a8bed10ee8">SameHemisphere</a>(wo, *wi)) <span class="keywordflow">return</span> <a class="code" href="classSpectrum.html">Spectrum</a>(0.<a class="code" href="classFresnelBlend.html#59104752a3144c9be628a433c3f1ef66">f</a>);
<a name="l00328"></a>00328         }
<a name="l00329"></a>00329         *pdf = <a class="code" href="classFresnelBlend.html#0a23a389557bed68d1dbb57e1d9851c1">Pdf</a>(wo, *wi);
<a name="l00330"></a>00330         <span class="keywordflow">return</span> <a class="code" href="classFresnelBlend.html#59104752a3144c9be628a433c3f1ef66">f</a>(wo, *wi);
<a name="l00331"></a>00331 }
<a name="l00332"></a><a class="code" href="classFresnelBlend.html#0a23a389557bed68d1dbb57e1d9851c1">00332</a> <span class="keywordtype">float</span> <a class="code" href="classFresnelBlend.html#0a23a389557bed68d1dbb57e1d9851c1">FresnelBlend::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo,
<a name="l00333"></a>00333                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wi)<span class="keyword"> const </span>{
<a name="l00334"></a>00334         <span class="keywordflow">if</span> (!<a class="code" href="reflection_8h.html#ebb77387f6dcac75991e45a8bed10ee8">SameHemisphere</a>(wo, wi)) <span class="keywordflow">return</span> 0.f;
<a name="l00335"></a>00335         <span class="keywordflow">return</span> .5f * (fabsf(wi.<a class="code" href="classVector.html#0e84237d0830d5c459bfa5676b5fbfba">z</a>) * <a class="code" href="pbrt_8h.html#ebad45bfa06a5d66805c5813fbc59f4b">INV_PI</a> +
<a name="l00336"></a>00336                 <a class="code" href="classFresnelBlend.html#2673c0a36ffad7fcf763ee58869f97f3">distribution</a>-&gt;<a class="code" href="classMicrofacetDistribution.html#7bbd3ac3e59d5efdcfda9a5f69bcc15b">Pdf</a>(wo, wi));
<a name="l00337"></a>00337 }
<a name="l00338"></a><a class="code" href="classBxDF.html#48caf2530fddb7248048fec7124c9031">00338</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBxDF.html#48caf2530fddb7248048fec7124c9031">BxDF::rho</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;w, <span class="keywordtype">int</span> nSamples,
<a name="l00339"></a>00339                 <span class="keywordtype">float</span> *samples)<span class="keyword"> const </span>{
<a name="l00340"></a>00340         <span class="keywordflow">if</span> (!samples) {
<a name="l00341"></a>00341                 samples =
<a name="l00342"></a>00342                         (<span class="keywordtype">float</span> *)alloca(2 * nSamples * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00343"></a>00343                 <a class="code" href="sampling_8cpp.html#63ab80f9467a105c11415509b6a3f45a">LatinHypercube</a>(samples, nSamples, 2);
<a name="l00344"></a>00344         }
<a name="l00345"></a>00345         <a class="code" href="classSpectrum.html">Spectrum</a> r = 0.;
<a name="l00346"></a>00346         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nSamples; ++i) {
<a name="l00347"></a>00347                 <span class="comment">// Estimate one term of $\rho_{dh}$</span>
<a name="l00348"></a>00348                 <a class="code" href="classVector.html">Vector</a> wi;
<a name="l00349"></a>00349                 <span class="keywordtype">float</span> pdf = 0.f;
<a name="l00350"></a>00350                 <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBxDF.html#f1ca9885bff59445b7bab31e70e060af">f</a> =
<a name="l00351"></a>00351                         <a class="code" href="classBxDF.html#34354c02d0f47926ebd477bddd2fcf0c">Sample_f</a>(w, &amp;wi, samples[2*i], samples[2*i+1], &amp;pdf);
<a name="l00352"></a>00352                 <span class="keywordflow">if</span> (pdf &gt; 0.) r += f * fabsf(wi.<a class="code" href="classVector.html#0e84237d0830d5c459bfa5676b5fbfba">z</a>) / pdf;
<a name="l00353"></a>00353         }
<a name="l00354"></a>00354         <span class="keywordflow">return</span> r / nSamples;
<a name="l00355"></a>00355 }
<a name="l00356"></a><a class="code" href="classBxDF.html#8ecac2e548e8351ea75c98ae10212479">00356</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBxDF.html#48caf2530fddb7248048fec7124c9031">BxDF::rho</a>(<span class="keywordtype">int</span> nSamples, <span class="keywordtype">float</span> *samples)<span class="keyword"> const </span>{
<a name="l00357"></a>00357         <span class="keywordflow">if</span> (!samples) {
<a name="l00358"></a>00358                 samples =
<a name="l00359"></a>00359                         (<span class="keywordtype">float</span> *)alloca(4 * nSamples * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00360"></a>00360                 <a class="code" href="sampling_8cpp.html#63ab80f9467a105c11415509b6a3f45a">LatinHypercube</a>(samples, nSamples, 4);
<a name="l00361"></a>00361         }
<a name="l00362"></a>00362         <a class="code" href="classSpectrum.html">Spectrum</a> r = 0.;
<a name="l00363"></a>00363         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nSamples; ++i) {
<a name="l00364"></a>00364                 <span class="comment">// Estimate one term of $\rho_{hh}$</span>
<a name="l00365"></a>00365                 <a class="code" href="classVector.html">Vector</a> wo, wi;
<a name="l00366"></a>00366                 wo = <a class="code" href="mc_8cpp.html#dd1b19fb39791c0744944a121267f832">UniformSampleHemisphere</a>(samples[4*i], samples[4*i+1]);
<a name="l00367"></a>00367                 <span class="keywordtype">float</span> pdf_o = <a class="code" href="pbrt_8h.html#42177ad937b6de334f376c039189e067">INV_TWOPI</a>, pdf_i = 0.f;
<a name="l00368"></a>00368                 <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBxDF.html#f1ca9885bff59445b7bab31e70e060af">f</a> =
<a name="l00369"></a>00369                         <a class="code" href="classBxDF.html#34354c02d0f47926ebd477bddd2fcf0c">Sample_f</a>(wo, &amp;wi, samples[4*i+2], samples[4*i+3],
<a name="l00370"></a>00370                                 &amp;pdf_i);
<a name="l00371"></a>00371                 <span class="keywordflow">if</span> (pdf_i &gt; 0.)
<a name="l00372"></a>00372                         r += f * fabsf(wi.<a class="code" href="classVector.html#0e84237d0830d5c459bfa5676b5fbfba">z</a> * wo.<a class="code" href="classVector.html#0e84237d0830d5c459bfa5676b5fbfba">z</a>) / (pdf_o * pdf_i);
<a name="l00373"></a>00373         }
<a name="l00374"></a>00374         <span class="keywordflow">return</span> r / (<a class="code" href="pbrt_8h.html#e71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*nSamples);
<a name="l00375"></a>00375 }
<a name="l00376"></a>00376 <span class="comment">// BSDF Method Definitions</span>
<a name="l00377"></a><a class="code" href="classBSDF.html#dcd231f67ff2f0fa69677d0bde532088">00377</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#3498bc3b7484a17abd8429084124a0d4">BSDF::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="classVector.html">Vector</a> *wi, <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730">BxDFType</a> flags,
<a name="l00378"></a>00378         <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730">BxDFType</a> *sampledType)<span class="keyword"> const </span>{
<a name="l00379"></a>00379         <span class="keywordtype">float</span> pdf;
<a name="l00380"></a>00380         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#137c0efa679347a2787b366effdeeb50">f</a> = <a class="code" href="classBSDF.html#3498bc3b7484a17abd8429084124a0d4">Sample_f</a>(wo, wi, <a class="code" href="pbrt_8h.html#4f11994534b888fcf650c04b5d61d9d4">RandomFloat</a>(), <a class="code" href="pbrt_8h.html#4f11994534b888fcf650c04b5d61d9d4">RandomFloat</a>(),
<a name="l00381"></a>00381                 <a class="code" href="pbrt_8h.html#4f11994534b888fcf650c04b5d61d9d4">RandomFloat</a>(), &amp;pdf, flags, sampledType);
<a name="l00382"></a>00382         <span class="keywordflow">if</span> (!f.<a class="code" href="classSpectrum.html#a05b9a07476998192a83fcd015b7619f">Black</a>() &amp;&amp; pdf &gt; 0.) f /= pdf;
<a name="l00383"></a>00383         <span class="keywordflow">return</span> f;
<a name="l00384"></a>00384 }
<a name="l00385"></a><a class="code" href="classBSDF.html#3498bc3b7484a17abd8429084124a0d4">00385</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#3498bc3b7484a17abd8429084124a0d4">BSDF::Sample_f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;woW, <a class="code" href="classVector.html">Vector</a> *wiW,
<a name="l00386"></a>00386                 <span class="keywordtype">float</span> u1, <span class="keywordtype">float</span> u2, <span class="keywordtype">float</span> u3, <span class="keywordtype">float</span> *pdf,
<a name="l00387"></a>00387                 <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730">BxDFType</a> flags, <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730">BxDFType</a> *sampledType)<span class="keyword"> const </span>{
<a name="l00388"></a>00388         <span class="comment">// Choose which _BxDF_ to sample</span>
<a name="l00389"></a>00389         <span class="keywordtype">int</span> matchingComps = <a class="code" href="classBSDF.html#e6d4c9a1826621a887a4ccd7fa7b5222">NumComponents</a>(flags);
<a name="l00390"></a>00390         <span class="keywordflow">if</span> (matchingComps == 0) {
<a name="l00391"></a>00391                 *pdf = 0.f;
<a name="l00392"></a>00392                 <span class="keywordflow">return</span> <a class="code" href="classSpectrum.html">Spectrum</a>(0.<a class="code" href="classBSDF.html#137c0efa679347a2787b366effdeeb50">f</a>);
<a name="l00393"></a>00393         }
<a name="l00394"></a>00394         <span class="keywordtype">int</span> which = min(<a class="code" href="pbrt_8h.html#02648670ea7bf29f5782902cd9aa87c1">Floor2Int</a>(u3 * matchingComps),
<a name="l00395"></a>00395                 matchingComps-1);
<a name="l00396"></a>00396         <a class="code" href="classBxDF.html">BxDF</a> *bxdf = NULL;
<a name="l00397"></a>00397         <span class="keywordtype">int</span> count = which;
<a name="l00398"></a>00398         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classBSDF.html#6205934f2c9bee387957f6f86c92aaa2">nBxDFs</a>; ++i)
<a name="l00399"></a>00399                 <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#51690579a8649ea27c9f13697b93a2f8">bxdfs</a>[i]-&gt;MatchesFlags(flags))
<a name="l00400"></a>00400                         <span class="keywordflow">if</span> (count-- == 0) {
<a name="l00401"></a>00401                                 bxdf = <a class="code" href="classBSDF.html#51690579a8649ea27c9f13697b93a2f8">bxdfs</a>[i];
<a name="l00402"></a>00402                                 <span class="keywordflow">break</span>;
<a name="l00403"></a>00403                         }
<a name="l00404"></a>00404         <a class="code" href="pbrt_8h.html#ab1e54dcc40192f9704e8b252635450f">Assert</a>(bxdf); <span class="comment">// NOBOOK</span>
<a name="l00405"></a>00405         <span class="comment">// Sample chosen _BxDF_</span>
<a name="l00406"></a>00406         <a class="code" href="classVector.html">Vector</a> wi;
<a name="l00407"></a>00407         <a class="code" href="classVector.html">Vector</a> wo = <a class="code" href="classBSDF.html#953198ff52bbfd1358d90fdb12a8ff2e">WorldToLocal</a>(woW);
<a name="l00408"></a>00408         *pdf = 0.f;
<a name="l00409"></a>00409         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#137c0efa679347a2787b366effdeeb50">f</a> = bxdf-&gt;<a class="code" href="classBxDF.html#34354c02d0f47926ebd477bddd2fcf0c">Sample_f</a>(wo, &amp;wi, u1, u2, pdf);
<a name="l00410"></a>00410         <span class="keywordflow">if</span> (*pdf == 0.f) <span class="keywordflow">return</span> 0.f;
<a name="l00411"></a>00411         <span class="keywordflow">if</span> (sampledType) *sampledType = bxdf-&gt;<a class="code" href="classBxDF.html#0828d72fbcded9e16cbd64ba81071ff3">type</a>;
<a name="l00412"></a>00412         *wiW = <a class="code" href="classBSDF.html#2dbc3471ca839e4ba07f2b45d6d53f62">LocalToWorld</a>(wi);
<a name="l00413"></a>00413         <span class="comment">// Compute overall PDF with all matching _BxDF_s</span>
<a name="l00414"></a>00414         <span class="keywordflow">if</span> (!(bxdf-&gt;<a class="code" href="classBxDF.html#0828d72fbcded9e16cbd64ba81071ff3">type</a> &amp; <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730c94ee1d195ff19883a79d1c08bd773d9">BSDF_SPECULAR</a>) &amp;&amp; matchingComps &gt; 1) {
<a name="l00415"></a>00415                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nBxDFs; ++i) {
<a name="l00416"></a>00416                         <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#51690579a8649ea27c9f13697b93a2f8">bxdfs</a>[i] != bxdf &amp;&amp;
<a name="l00417"></a>00417                             <a class="code" href="classBSDF.html#51690579a8649ea27c9f13697b93a2f8">bxdfs</a>[i]-&gt;MatchesFlags(flags))
<a name="l00418"></a>00418                                 *pdf += <a class="code" href="classBSDF.html#51690579a8649ea27c9f13697b93a2f8">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#c0f2ffe7dfa375ccb8d03519a39e33e6">Pdf</a>(wo, wi);
<a name="l00419"></a>00419                 }
<a name="l00420"></a>00420         }
<a name="l00421"></a>00421         <span class="keywordflow">if</span> (matchingComps &gt; 1) *pdf /= matchingComps;
<a name="l00422"></a>00422         <span class="comment">// Compute value of BSDF for sampled direction</span>
<a name="l00423"></a>00423         <span class="keywordflow">if</span> (!(bxdf-&gt;<a class="code" href="classBxDF.html#0828d72fbcded9e16cbd64ba81071ff3">type</a> &amp; <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730c94ee1d195ff19883a79d1c08bd773d9">BSDF_SPECULAR</a>)) {
<a name="l00424"></a>00424                 f = 0.;
<a name="l00425"></a>00425                 <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(*wiW, <a class="code" href="classBSDF.html#450c9189de716a759dc5ce87eddbb28e">ng</a>) * <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(woW, <a class="code" href="classBSDF.html#450c9189de716a759dc5ce87eddbb28e">ng</a>) &gt; 0)
<a name="l00426"></a>00426                         <span class="comment">// ignore BTDFs</span>
<a name="l00427"></a>00427                         flags = <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730">BxDFType</a>(flags &amp; ~<a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730806674394a395d5dc6383956e4f2733f">BSDF_TRANSMISSION</a>);
<a name="l00428"></a>00428                 <span class="keywordflow">else</span>
<a name="l00429"></a>00429                         <span class="comment">// ignore BRDFs</span>
<a name="l00430"></a>00430                         flags = <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730">BxDFType</a>(flags &amp; ~<a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e6697304331da0ab7ddceadcfffa81ecf70577e">BSDF_REFLECTION</a>);
<a name="l00431"></a>00431                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nBxDFs; ++i)
<a name="l00432"></a>00432                         <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#51690579a8649ea27c9f13697b93a2f8">bxdfs</a>[i]-&gt;MatchesFlags(flags))
<a name="l00433"></a>00433                                 f += <a class="code" href="classBSDF.html#51690579a8649ea27c9f13697b93a2f8">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#f1ca9885bff59445b7bab31e70e060af">f</a>(wo, wi);
<a name="l00434"></a>00434         }
<a name="l00435"></a>00435         <span class="keywordflow">return</span> f;
<a name="l00436"></a>00436 }
<a name="l00437"></a><a class="code" href="classBSDF.html#341ca28cdacdbc5286bea45c510fc53a">00437</a> <span class="keywordtype">float</span> <a class="code" href="classBSDF.html#341ca28cdacdbc5286bea45c510fc53a">BSDF::Pdf</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;woW, <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wiW,
<a name="l00438"></a>00438                 <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730">BxDFType</a> flags)<span class="keyword"> const </span>{
<a name="l00439"></a>00439         <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#6205934f2c9bee387957f6f86c92aaa2">nBxDFs</a> == 0.) <span class="keywordflow">return</span> 0.;
<a name="l00440"></a>00440         <a class="code" href="classVector.html">Vector</a> wo = <a class="code" href="classBSDF.html#953198ff52bbfd1358d90fdb12a8ff2e">WorldToLocal</a>(woW), wi = <a class="code" href="classBSDF.html#953198ff52bbfd1358d90fdb12a8ff2e">WorldToLocal</a>(wiW);
<a name="l00441"></a>00441         <span class="keywordtype">float</span> pdf = 0.f;
<a name="l00442"></a>00442         <span class="keywordtype">int</span> matchingComps = 0;
<a name="l00443"></a>00443         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classBSDF.html#6205934f2c9bee387957f6f86c92aaa2">nBxDFs</a>; ++i)
<a name="l00444"></a>00444                 <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#51690579a8649ea27c9f13697b93a2f8">bxdfs</a>[i]-&gt;MatchesFlags(flags)) {
<a name="l00445"></a>00445                         ++matchingComps;
<a name="l00446"></a>00446                         pdf += <a class="code" href="classBSDF.html#51690579a8649ea27c9f13697b93a2f8">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#c0f2ffe7dfa375ccb8d03519a39e33e6">Pdf</a>(wo, wi);
<a name="l00447"></a>00447                 }
<a name="l00448"></a>00448         <span class="keywordflow">return</span> matchingComps &gt; 0 ? pdf / matchingComps : 0.f;
<a name="l00449"></a>00449 }
<a name="l00450"></a><a class="code" href="classBSDF.html#a3e12fb1c67ad174bda5198816a368e2">00450</a> <a class="code" href="classBSDF.html#a3e12fb1c67ad174bda5198816a368e2">BSDF::BSDF</a>(<span class="keyword">const</span> <a class="code" href="structDifferentialGeometry.html">DifferentialGeometry</a> &amp;dg,
<a name="l00451"></a>00451            <span class="keyword">const</span> <a class="code" href="classNormal.html">Normal</a> &amp;ngeom, <span class="keywordtype">float</span> e)
<a name="l00452"></a>00452         : <a class="code" href="classBSDF.html#4fbebe2038bb049c50deba997a497f2d">dgShading</a>(dg), <a class="code" href="classBSDF.html#1ce3e1bc653569c466bba6ca6666f419">eta</a>(e) {
<a name="l00453"></a>00453         <a class="code" href="classBSDF.html#450c9189de716a759dc5ce87eddbb28e">ng</a> = ngeom;
<a name="l00454"></a>00454         <a class="code" href="classBSDF.html#38edff97706397c2326a9bf43788638c">nn</a> = <a class="code" href="classBSDF.html#4fbebe2038bb049c50deba997a497f2d">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#1aa044f6c7b053ca460c10b0cf832c14">nn</a>;
<a name="l00455"></a>00455         <a class="code" href="classBSDF.html#0f44a55a492d926f0e0f2f110bc097ab">sn</a> = <a class="code" href="geometry_8h.html#46448bfa3df1c2de5e3b763f163866a4">Normalize</a>(<a class="code" href="classBSDF.html#4fbebe2038bb049c50deba997a497f2d">dgShading</a>.<a class="code" href="structDifferentialGeometry.html#e43d9aa60e973454b9f75800a09027da">dpdu</a>);
<a name="l00456"></a>00456         <a class="code" href="classBSDF.html#9b3be31ae55d8d3bc77431f1f8f14aa0">tn</a> = <a class="code" href="geometry_8h.html#340d6d877ba46443c9ad20e7c0d0668f">Cross</a>(<a class="code" href="classBSDF.html#38edff97706397c2326a9bf43788638c">nn</a>, <a class="code" href="classBSDF.html#0f44a55a492d926f0e0f2f110bc097ab">sn</a>);
<a name="l00457"></a>00457         <a class="code" href="classBSDF.html#6205934f2c9bee387957f6f86c92aaa2">nBxDFs</a> = 0;
<a name="l00458"></a>00458 }
<a name="l00459"></a><a class="code" href="classBSDF.html#137c0efa679347a2787b366effdeeb50">00459</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#137c0efa679347a2787b366effdeeb50">BSDF::f</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;woW,
<a name="l00460"></a>00460                 <span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wiW, <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730">BxDFType</a> flags)<span class="keyword"> const </span>{
<a name="l00461"></a>00461         <a class="code" href="classVector.html">Vector</a> wi = <a class="code" href="classBSDF.html#953198ff52bbfd1358d90fdb12a8ff2e">WorldToLocal</a>(wiW), wo = <a class="code" href="classBSDF.html#953198ff52bbfd1358d90fdb12a8ff2e">WorldToLocal</a>(woW);
<a name="l00462"></a>00462         <span class="keywordflow">if</span> (<a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(wiW, <a class="code" href="classBSDF.html#450c9189de716a759dc5ce87eddbb28e">ng</a>) * <a class="code" href="geometry_8h.html#ad0d36688d190693f70a5c9ef9342914">Dot</a>(woW, <a class="code" href="classBSDF.html#450c9189de716a759dc5ce87eddbb28e">ng</a>) &gt; 0)
<a name="l00463"></a>00463                 <span class="comment">// ignore BTDFs</span>
<a name="l00464"></a>00464                 flags = <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730">BxDFType</a>(flags &amp; ~<a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730806674394a395d5dc6383956e4f2733f">BSDF_TRANSMISSION</a>);
<a name="l00465"></a>00465         <span class="keywordflow">else</span>
<a name="l00466"></a>00466                 <span class="comment">// ignore BRDFs</span>
<a name="l00467"></a>00467                 flags = <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730">BxDFType</a>(flags &amp; ~<a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e6697304331da0ab7ddceadcfffa81ecf70577e">BSDF_REFLECTION</a>);
<a name="l00468"></a>00468         <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#137c0efa679347a2787b366effdeeb50">f</a> = 0.;
<a name="l00469"></a>00469         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classBSDF.html#6205934f2c9bee387957f6f86c92aaa2">nBxDFs</a>; ++i)
<a name="l00470"></a>00470                 <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#51690579a8649ea27c9f13697b93a2f8">bxdfs</a>[i]-&gt;MatchesFlags(flags))
<a name="l00471"></a>00471                         f += <a class="code" href="classBSDF.html#51690579a8649ea27c9f13697b93a2f8">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#f1ca9885bff59445b7bab31e70e060af">f</a>(wo, wi);
<a name="l00472"></a>00472         <span class="keywordflow">return</span> f;
<a name="l00473"></a>00473 }
<a name="l00474"></a><a class="code" href="classBSDF.html#0aa3132935c2c62d824b3bd45f6939d9">00474</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#0aa3132935c2c62d824b3bd45f6939d9">BSDF::rho</a>(<a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730">BxDFType</a> flags)<span class="keyword"> const </span>{
<a name="l00475"></a>00475         <a class="code" href="classSpectrum.html">Spectrum</a> ret(0.);
<a name="l00476"></a>00476         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classBSDF.html#6205934f2c9bee387957f6f86c92aaa2">nBxDFs</a>; ++i)
<a name="l00477"></a>00477                 <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#51690579a8649ea27c9f13697b93a2f8">bxdfs</a>[i]-&gt;MatchesFlags(flags))
<a name="l00478"></a>00478                         ret += <a class="code" href="classBSDF.html#51690579a8649ea27c9f13697b93a2f8">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#48caf2530fddb7248048fec7124c9031">rho</a>();
<a name="l00479"></a>00479         <span class="keywordflow">return</span> ret;
<a name="l00480"></a>00480 }
<a name="l00481"></a><a class="code" href="classBSDF.html#9d19483f3e0a788fd8468efbf1238c33">00481</a> <a class="code" href="classSpectrum.html">Spectrum</a> <a class="code" href="classBSDF.html#0aa3132935c2c62d824b3bd45f6939d9">BSDF::rho</a>(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector</a> &amp;wo, <a class="code" href="reflection_8h.html#0ab5fa7d70a51348af4188bf1e669730">BxDFType</a> flags)<span class="keyword"> const </span>{
<a name="l00482"></a>00482         <a class="code" href="classSpectrum.html">Spectrum</a> ret(0.);
<a name="l00483"></a>00483         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classBSDF.html#6205934f2c9bee387957f6f86c92aaa2">nBxDFs</a>; ++i)
<a name="l00484"></a>00484                 <span class="keywordflow">if</span> (<a class="code" href="classBSDF.html#51690579a8649ea27c9f13697b93a2f8">bxdfs</a>[i]-&gt;MatchesFlags(flags))
<a name="l00485"></a>00485                         ret += <a class="code" href="classBSDF.html#51690579a8649ea27c9f13697b93a2f8">bxdfs</a>[i]-&gt;<a class="code" href="classBxDF.html#48caf2530fddb7248048fec7124c9031">rho</a>(wo);
<a name="l00486"></a>00486         <span class="keywordflow">return</span> ret;
<a name="l00487"></a>00487 }
<a name="l00488"></a>00488 <a class="code" href="classMemoryArena.html">MemoryArena</a> <a class="code" href="classBSDF.html#f375a557a7c8739f7dc67c4905cab1fc">BSDF::arena</a>;
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Jul 20 17:31:53 2009 for pbrt by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
